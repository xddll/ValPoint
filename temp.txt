// @ts-nocheck
import React, { useEffect, useMemo, useState, useCallback } from 'react';
import LeafletMap from './components/LeafletMap';
import { CUSTOM_MAP_URLS, MAP_TRANSLATIONS } from './constants/maps';
import MapPickerModal from './components/MapPickerModal';
import PreviewModal from './components/PreviewModal';
import AlertModal from './components/AlertModal';
import DeleteConfirmModal from './components/DeleteConfirmModal';
import Lightbox from './components/Lightbox';
import EditorModal from './components/EditorModal';
import ViewerModal from './components/ViewerModal';
import LeftPanel from './components/LeftPanel';
import RightPanel from './components/RightPanel';
import Icon from './components/Icon';
import { supabase } from './supabaseClient';

const LOCAL_USER_KEY = 'valpoint_user_id';
const TABLE = 'valorant_lineups';

const ensureUserId = () => {
  let id = localStorage.getItem(LOCAL_USER_KEY);
  if (!id) {
    id = crypto.randomUUID();
    localStorage.setItem(LOCAL_USER_KEY, id);
  }
  return id;
};

const toDbPayload = (data, userId) => ({
  title: data.title,
  map_name: data.mapName,
  agent_name: data.agentName,
  agent_icon: data.agentIcon,
  skill_icon: data.skillIcon,
  side: data.side,
  ability_index: data.abilityIndex,
  agent_pos: data.agentPos,
  skill_pos: data.skillPos,
  stand_img: data.standImg,
  stand_desc: data.standDesc,
  aim_img: data.aimImg,
  aim_desc: data.aimDesc,
  aim2_img: data.aim2Img,
  aim2_desc: data.aim2Desc,
  land_img: data.landImg,
  land_desc: data.landDesc,
  user_id: userId,
  cloned_from: data.clonedFrom || null,
});

const normalizeLineup = (raw, mapNameZhToEn) => {
  const pick = (a, b) => (a !== undefined ? a : b);
  const mapNameRaw = pick(raw.map_name, raw.mapName);
  return {
    id: raw.id,
    title: pick(raw.title, ''),
    mapName: mapNameZhToEn[mapNameRaw] || mapNameRaw,
    agentName: pick(raw.agent_name, raw.agentName),
    agentIcon: pick(raw.agent_icon, raw.agentIcon),
    skillIcon: pick(raw.skill_icon, raw.skillIcon),
    side: pick(raw.side, 'attack'),
    abilityIndex: pick(raw.ability_index, raw.abilityIndex),
    agentPos: pick(raw.agent_pos, raw.agentPos),
    skillPos: pick(raw.skill_pos, raw.skillPos),
    standImg: pick(raw.stand_img, raw.standImg),
    standDesc: pick(raw.stand_desc, raw.standDesc),
    aimImg: pick(raw.aim_img, raw.aimImg),
    aimDesc: pick(raw.aim_desc, raw.aimDesc),
    aim2Img: pick(raw.aim2_img, raw.aim2Img),
    aim2Desc: pick(raw.aim2_desc, raw.aim2Desc),
    landImg: pick(raw.land_img, raw.landImg),
    landDesc: pick(raw.land_desc, raw.landDesc),
    createdAt: pick(raw.created_at, raw.createdAt),
    updatedAt: pick(raw.updated_at, raw.updatedAt),
    clonedFrom: pick(raw.cloned_from, raw.clonedFrom),
    userId: pick(raw.user_id, raw.userId),
  };
};

function App() {
  const [userId, setUserId] = useState(null);
  const [activeTab, setActiveTab] = useState('view');
  const [selectedMap, setSelectedMap] = useState(null);
  const [selectedAgent, setSelectedAgent] = useState(null);
  const [selectedSide, setSelectedSide] = useState('all');
  const [selectedAbilityIndex, setSelectedAbilityIndex] = useState(null);
  const [maps, setMaps] = useState([]);
  const [agents, setAgents] = useState([]);
  const [lineups, setLineups] = useState([]);
  const [isMapModalOpen, setIsMapModalOpen] = useState(false);
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedLineupId, setSelectedLineupId] = useState(null);
  const [deleteTargetId, setDeleteTargetId] = useState(null);
  const [alertMessage, setAlertMessage] = useState(null);
  const [isEditorOpen, setIsEditorOpen] = useState(false);
  const [viewingLineup, setViewingLineup] = useState(null);
  const [viewingImage, setViewingImage] = useState(null);
  const [editingLineupId, setEditingLineupId] = useState(null);
  const [isPreviewModalOpen, setIsPreviewModalOpen] = useState(false);
  const [previewInput, setPreviewInput] = useState('');
  const [isClearConfirmOpen, setIsClearConfirmOpen] = useState(false);
  const [sharedLineup, setSharedLineup] = useState(null);
  const [newLineupData, setNewLineupData] = useState({
    title: '',
    agentPos: null,
    skillPos: null,
    standImg: '',
    standDesc: '',
    aimImg: '',
    aimDesc: '',
    aim2Img: '',
    aim2Desc: '',
    landImg: '',
    landDesc: '',
  });
  const [placingType, setPlacingType] = useState(null);

  const getMapDisplayName = (apiMapName) => MAP_TRANSLATIONS[apiMapName] || apiMapName;
  const getMapEnglishName = (displayName) =>
    Object.keys(MAP_TRANSLATIONS).find((key) => MAP_TRANSLATIONS[key] === displayName) || displayName;

  const mapNameZhToEn = useMemo(() => {
    const reverse = {};
    Object.entries(MAP_TRANSLATIONS).forEach(([en, zh]) => {
      reverse[zh] = en;
    });
    return reverse;
  }, []);

  const agentCounts = useMemo(() => {
    if (!selectedMap) return {};
    const mapKey = selectedMap.displayName;
    const counts = {};
    lineups.forEach((l) => {
      if (l.mapName !== mapKey) return;
      if (selectedSide !== 'all' && l.side !== selectedSide) return;
      counts[l.agentName] = (counts[l.agentName] || 0) + 1;
    });
    return counts;
  }, [lineups, selectedMap, selectedSide]);

  const filteredLineups = useMemo(() => {
    if (!selectedMap) return [];
    const mapKey = selectedMap.displayName;
    return lineups.filter((l) => {
      const mapMatch = l.mapName === mapKey;
      const agentMatch = !selectedAgent || l.agentName === selectedAgent.displayName;
      const sideMatch = selectedSide === 'all' || l.side === selectedSide;
      const abilityMatch = selectedAbilityIndex === null || l.abilityIndex === selectedAbilityIndex;
      const searchMatch = !searchQuery || l.title.toLowerCase().includes(searchQuery.toLowerCase());
      return mapMatch && agentMatch && sideMatch && abilityMatch && searchMatch;
    });
  }, [lineups, selectedMap, selectedAgent, selectedSide, selectedAbilityIndex, searchQuery]);

  const fetchLineups = useCallback(async () => {
    if (!userId) return;
    const { data, error } = await supabase
      .from(TABLE)
      .select('*')
      .eq('user_id', userId)
      .order('created_at', { ascending: false });
    if (error) {
      console.error('Supabase fetch error', error);
      return;
    }
    const normalized = data.map((d) => normalizeLineup(d, mapNameZhToEn));
    setLineups(normalized);
  }, [userId, mapNameZhToEn]);

  useEffect(() => {
    const id = ensureUserId();
    setUserId(id);

    fetch('https://valorant-api.com/v1/maps')
      .then((res) => res.json())
      .then((data) => {
        const validMaps = data.data.filter((m) => MAP_TRANSLATIONS[m.displayName] || CUSTOM_MAP_URLS[m.displayName]);
        setMaps(validMaps);
        if (validMaps.length > 0) {
          const ascent = validMaps.find((m) => m.displayName === 'Ascent');
          setSelectedMap(ascent || validMaps[0]);
        }
      });

    fetch('https://valorant-api.com/v1/agents?language=zh-CN&isPlayableCharacter=true')
      .then((res) => res.json())
      .then((data) => {
        const sorted = data.data.sort((a, b) => a.displayName.localeCompare(b.displayName));
        setAgents(sorted);
        const sova = sorted.find((a) => a.displayName === 'ç´¢ç“¦' || a.displayName === 'Sova');
        if (sova) setSelectedAgent(sova);
        else if (sorted.length > 0) setSelectedAgent(sorted[0]);
      });

    const params = new URLSearchParams(window.location.search);
    if (params.get('id')) setActiveTab('shared');
  }, []);

  useEffect(() => {
    fetchLineups();
  }, [fetchLineups]);

  useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    const shareId = params.get('id');
    if (!shareId) return;
    const load = async () => {
      const { data, error } = await supabase.from(TABLE).select('*').eq('id', shareId).single();
      if (error || !data) {
        setAlertMessage('æœªæ‰¾åˆ°è¯¥ç‚¹ä½åˆ†äº«ï¼Œå¯èƒ½å·²è¢«åˆ é™¤ã€?);
        setActiveTab('view');
        return;
      }
      setSharedLineup(normalizeLineup(data, mapNameZhToEn));
    };
    load();
  }, [mapNameZhToEn]);

  const handlePreviewSubmit = async () => {
    if (!previewInput.trim()) return;
    let idToLoad = previewInput.trim();
    try {
      const url = new URL(idToLoad);
      const idParam = url.searchParams.get('id');
      if (idParam) idToLoad = idParam;
    } catch (e) {}
    const { data, error } = await supabase.from(TABLE).select('*').eq('id', idToLoad).single();
    if (error || !data) {
      setAlertMessage('æœªæ‰¾åˆ°è¯¥ ID å¯¹åº”çš„ç‚¹ä½ã€?);
      return;
    }
    setSharedLineup(normalizeLineup(data, mapNameZhToEn));
    setActiveTab('shared');
    setIsPreviewModalOpen(false);
    setPreviewInput('');
  };

  const handleTabSwitch = (tab) => {
    setActiveTab(tab);
    setPlacingType(null);
    setSelectedLineupId(null);
    setViewingLineup(null);
    setEditingLineupId(null);
    setSharedLineup(null);
    if (tab !== 'shared') {
      try {
        window.history.replaceState({}, document.title, window.location.pathname);
      } catch (e) {}
    }
    if (tab === 'create') {
      setNewLineupData({
        title: '',
        agentPos: null,
        skillPos: null,
        standImg: '',
        standDesc: '',
        aimImg: '',
        aimDesc: '',
        aim2Img: '',
        aim2Desc: '',
        landImg: '',
        landDesc: '',
      });
      if (selectedSide === 'all') setSelectedSide('attack');
    } else if (tab === 'view') {
      // è¿”å›æŸ¥çœ‹æ—¶é‡ç½®ç­›é€‰å¹¶ä¸»åŠ¨åˆ·æ–°ï¼Œé¿å…æ—§æ•°æ®è¢«ç­›æ‰ï¼›é»˜è®¤é€‰ä¸­é¦–ä¸ªç‰¹å·¥
      setSelectedSide('all');
      setSelectedAbilityIndex(null);
      const firstAgent = agents[0];
      if (firstAgent) setSelectedAgent(firstAgent);
      fetchLineups();
    }
  };

  const handleOpenEditor = () => {
    if (!newLineupData.agentPos || !newLineupData.skillPos) return setAlertMessage('è¯·å…ˆåœ¨åœ°å›¾ä¸Šå®Œæˆæ ‡æ³¨');
    if (!selectedAgent) return setAlertMessage('è¯·å…ˆé€‰æ‹©ä¸€åç‰¹å·?);
    setIsEditorOpen(true);
  };

  const handleEditStart = (lineup) => {
    const mapObj = maps.find((m) => getMapDisplayName(m.displayName) === lineup.mapName || m.displayName === lineup.mapName);
    if (mapObj) setSelectedMap(mapObj);
    const agentObj = agents.find((a) => a.displayName === lineup.agentName);
    if (agentObj) setSelectedAgent(agentObj);
    setSelectedSide(lineup.side);
    setSelectedAbilityIndex(lineup.abilityIndex);
    setNewLineupData({
      title: lineup.title,
      agentPos: lineup.agentPos,
      skillPos: lineup.skillPos,
      standImg: lineup.standImg || '',
      standDesc: lineup.standDesc || '',
      aimImg: lineup.aimImg || '',
      aimDesc: lineup.aimDesc || '',
      aim2Img: lineup.aim2Img || '',
      aim2Desc: lineup.aim2Desc || '',
      landImg: lineup.landImg || '',
      landDesc: lineup.landDesc || '',
    });
    setEditingLineupId(lineup.id);
    setViewingLineup(null);
    setActiveTab('create');
    setIsEditorOpen(true);
  };

  const handleEditorSave = async () => {
    if (!newLineupData.title.trim()) return setAlertMessage('æ ‡é¢˜ä¸èƒ½ä¸ºç©º');
    const commonData = {
      ...newLineupData,
      mapName: selectedMap.displayName,
      agentName: selectedAgent.displayName,
      agentIcon: selectedAgent.displayIcon,
      skillIcon: selectedAbilityIndex !== null ? selectedAgent.abilities[selectedAbilityIndex].displayIcon : null,
      side: selectedSide,
      abilityIndex: selectedAbilityIndex,
    };
    try {
      if (editingLineupId) {
        const { error } = await supabase
          .from(TABLE)
          .update({ ...toDbPayload(commonData, userId), updated_at: new Date().toISOString() })
          .eq('id', editingLineupId);
        if (error) throw error;
        setAlertMessage('æ›´æ–°æˆåŠŸ');
      } else {
        const { error } = await supabase.from(TABLE).insert({ ...toDbPayload(commonData, userId), created_at: new Date().toISOString() });
        if (error) throw error;
        setAlertMessage('ä¿å­˜æˆåŠŸ');
      }
      setIsEditorOpen(false);
      setEditingLineupId(null);
      setNewLineupData({ title: '', agentPos: null, skillPos: null, standImg: '', standDesc: '', aimImg: '', aimDesc: '', aim2Img: '', aim2Desc: '', landImg: '', landDesc: '' });
      fetchLineups();
    } catch (e) {
      console.error(e);
      setAlertMessage('ä¿å­˜å¤±è´¥');
    }
  };

  const handleRequestDelete = (id, e) => {
    e.stopPropagation();
    setDeleteTargetId(id);
  };

  const performDelete = async () => {
    if (!deleteTargetId) return;
    const { error } = await supabase.from(TABLE).delete().eq('id', deleteTargetId);
    if (error) {
      setAlertMessage('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•ã€?);
    } else {
      if (selectedLineupId === deleteTargetId) {
        setSelectedLineupId(null);
        setViewingLineup(null);
      }
      setDeleteTargetId(null);
      fetchLineups();
    }
  };

  const handleShare = (id, e) => {
    e.stopPropagation();
    // ä»…å¤åˆ¶ç‚¹ä½?IDï¼Œé¿å…æš´éœ²åŸŸå?IP
    const url = id;
    const textArea = document.createElement('textarea');
    textArea.value = url;
    textArea.style.position = 'fixed';
    textArea.style.left = '-9999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    try {
      document.execCommand('copy');
      setAlertMessage('ç‚¹ä½ ID å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼Œå¯ç›´æ¥å‘é€ç»™å¥½å‹');
    } catch (err) {
      setAlertMessage('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ IDï¼š\n' + url);
    }
    document.body.removeChild(textArea);
  };

  const togglePlacingType = (type) => setPlacingType((prev) => (prev === type ? null : type));

  const handleClearAll = () => {
    if (!lineups.length) {
      setAlertMessage('å½“å‰æ²¡æœ‰å¯åˆ é™¤çš„ç‚¹ä½ã€?);
      return;
    }
    setIsClearConfirmOpen(true);
  };

  const performClearAll = async () => {
    const { error } = await supabase.from(TABLE).delete().eq('user_id', userId);
    if (error) {
      setAlertMessage('æ¸…ç©ºå¤±è´¥ï¼Œè¯·é‡è¯•ã€?);
    } else {
      setIsClearConfirmOpen(false);
      setSelectedLineupId(null);
      setViewingLineup(null);
      setAlertMessage('å·²æ¸…ç©ºå½“å‰è´¦å·çš„ç‚¹ä½ã€?);
      fetchLineups();
    }
  };

  const handleSaveShared = async () => {
    if (!sharedLineup) return;
    try {
      const mapNameEn = getMapEnglishName(sharedLineup.mapName);
      const { id, ...data } = sharedLineup;
      const payload = {
        ...data,
        mapName: mapNameEn,
        agentPos: data.agentPos,
        skillPos: data.skillPos,
        clonedFrom: id,
      };
      const { error } = await supabase.from(TABLE).insert({ ...toDbPayload(payload, userId), created_at: new Date().toISOString() });
      if (error) throw error;
      setAlertMessage('å·²æˆåŠŸä¿å­˜åˆ°æ‚¨çš„ç‚¹ä½åˆ—è¡¨');
      handleTabSwitch('view');
      fetchLineups();
    } catch (err) {
      console.error(err);
      setAlertMessage('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•ã€?);
    }
  };

  const handleViewLineup = useCallback(
    (id) => {
      setSelectedLineupId(id);
      const lineup = lineups.find((l) => l.id === id);
      if (lineup) setViewingLineup(lineup);
    },
    [lineups],
  );

  const isFlipped = activeTab === 'shared' ? sharedLineup?.side === 'defense' : selectedSide === 'defense';
  const mapLineups = useMemo(() => {
    if (activeTab === 'shared' && sharedLineup) return [sharedLineup];
    if (activeTab === 'view' || activeTab === 'create') return filteredLineups;
    return lineups;
  }, [activeTab, sharedLineup, filteredLineups, lineups]);

  const getMapUrl = () => {
    if (activeTab === 'shared' && sharedLineup) {
      const enName = getMapEnglishName(sharedLineup.mapName);
      const config = CUSTOM_MAP_URLS[enName];
      if (config) return sharedLineup.side === 'defense' ? config.defense : config.attack;
    }
    if (!selectedMap) return null;
    const config = CUSTOM_MAP_URLS[selectedMap.displayName];
    if (config) return selectedSide === 'defense' ? config.defense : config.attack;
    return selectedMap.displayIcon;
  };

  if (activeTab === 'shared' && sharedLineup) {
    return (
      <div className="flex h-screen w-screen bg-[#0f1923] text-white overflow-hidden">
        <div className="w-[360px] flex-shrink-0 flex flex-col bg-[#1f2326] border-r border-white/10 z-20 shadow-2xl">
          <div className="h-16 flex items-center justify-between gap-3 px-6 border-b border-white/5 bg-[#1f2326] shadow-sm">
            <div className="flex items-center gap-3">
              <img src="/brand-logo.svg" alt="Logo" className="w-[168px] h-[32px]" />
            </div>
            <button onClick={() => handleTabSwitch('view')} className="flex items-center gap-2 text-xs text-gray-400 hover:text-white transition-colors">
              è¿”å›ä¸»é¡µ
            </button>
          </div>

          <div className="p-6 border-b border-white/10 bg-[#252a30]">
            <div className="flex items-center justify-between gap-3 mb-2">
              <div className="flex items-center gap-3">
                <span className={`text-xs font-bold px-2 py-0.5 rounded ${sharedLineup.side === 'attack' ? 'bg-red-500/20 text-red-400' : 'bg-emerald-500/20 text-emerald-400'}`}>
                  {sharedLineup.side === 'attack' ? 'è¿›æ”» (ATK)' : 'é˜²å®ˆ (DEF)'}
                </span>
                <span className="text-xs text-gray-400 font-mono uppercase tracking-wider">
                  {getMapDisplayName(getMapEnglishName(sharedLineup.mapName))}
                </span>
              </div>
              <button
                onClick={handleSaveShared}
                className="flex items-center gap-1 text-xs text-emerald-400 hover:text-emerald-200 transition-colors px-2 py-1 rounded bg-emerald-500/10 border border-emerald-500/30"
              >
                <Icon name="Save" size={14} /> ä¿å­˜åˆ°æˆ‘çš„ç‚¹ä½?              </button>
            </div>
            <h2 className="text-2xl font-bold text-white leading-tight mb-4">{sharedLineup.title}</h2>
            <div className="flex items-center gap-3 text-sm text-gray-400">
              {sharedLineup.agentIcon && <img src={sharedLineup.agentIcon} className="w-8 h-8 rounded-full" />}
              <span className="font-bold">{sharedLineup.agentName}</span>
            </div>
          </div>

          <div className="flex-1 overflow-y-auto p-6 space-y-4 bg-[#181b1f]">
            <div className="grid grid-cols-1 gap-4">
              {[
                { src: sharedLineup.standImg, desc: sharedLineup.standDesc, label: '1. ç«™ä½ (Stand)' },
                { src: sharedLineup.aimImg, desc: sharedLineup.aimDesc, label: '2. ç„ç‚¹ 1 (Aim)' },
                { src: sharedLineup.aim2Img, desc: sharedLineup.aim2Desc, label: '3. ç„ç‚¹ 2 (Aim)' },
                { src: sharedLineup.landImg, desc: sharedLineup.landDesc, label: '4. è½ç‚¹ (Land)' },
              ].map((item, idx) =>
                item.src ? (
                  <div key={idx} className="flex flex-col gap-2">
                    <div className="text-[#ff4655] font-bold text-xs uppercase tracking-wider">{item.label}</div>
                    <div
                      className="relative group cursor-zoom-in aspect-video bg-[#0f1923] rounded-lg overflow-hidden border border-white/10 hover:border-[#ff4655] transition-colors"
                      onClick={() => setViewingImage(item.src)}
                    >
                      <img src={item.src} className="w-full h-full object-cover" />
                      <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                        <Icon name="Maximize2" className="text-white" />
                      </div>
                    </div>
                    {item.desc && <div className="text-xs text-gray-300 bg-black/20 p-2 rounded border border-white/5">{item.desc}</div>}
                  </div>
                ) : null,
              )}
            </div>
            {!sharedLineup.standImg && !sharedLineup.aimImg && !sharedLineup.aim2Img && !sharedLineup.landImg && (
              <div className="h-full flex items-center justify-center text-gray-500 text-sm">æš‚æ— å›¾ç‰‡èµ„æ–™</div>
            )}
          </div>

        </div>
        <div className="flex-1 relative bg-[#0f1923] z-0 border-l border-r border-white/10">
          <LeafletMap
            mapIcon={getMapUrl()}
            activeTab="shared"
            lineups={sharedLineup ? [sharedLineup] : []}
            selectedLineupId={sharedLineup?.id || null}
            onLineupSelect={() => {}}
            newLineupData={newLineupData}
            setNewLineupData={setNewLineupData}
            placingType={placingType}
            setPlacingType={setPlacingType}
            selectedAgent={selectedAgent}
            selectedAbilityIndex={selectedAbilityIndex}
            onViewLineup={handleViewLineup}
            isFlipped={isFlipped}
            sharedLineup={sharedLineup}
          />
        </div>
        <Lightbox viewingImage={viewingImage} setViewingImage={setViewingImage} />
      </div>
    );
  }

  return (
    <div className="flex h-screen w-screen bg-[#0f1923] text-white overflow-hidden">
      <LeftPanel
        activeTab={activeTab}
        selectedMap={selectedMap}
        setIsMapModalOpen={setIsMapModalOpen}
        selectedSide={selectedSide}
        setSelectedSide={setSelectedSide}
        selectedAgent={selectedAgent}
        setSelectedAgent={setSelectedAgent}
        agents={agents}
        agentCounts={agentCounts}
        selectedAbilityIndex={selectedAbilityIndex}
        setSelectedAbilityIndex={setSelectedAbilityIndex}
        setIsPreviewModalOpen={setIsPreviewModalOpen}
        getMapDisplayName={getMapDisplayName}
      />

      <div className="flex-1 relative bg-[#0f1923] z-0 border-l border-r border-white/10">
        <div className="absolute top-6 left-6 z-[400] pointer-events-none">
          <div className="glass px-6 py-3 rounded-r-xl border-l-4 border-[#ff4655] shadow-2xl backdrop-blur-md bg-black/50">
            <div className="text-xs uppercase tracking-[0.2em] text-gray-300 font-bold">Map</div>
            <div className="text-lg font-bold text-white">{selectedMap ? getMapDisplayName(selectedMap.displayName) : 'åŠ è½½ä¸?..'}</div>
            <div className="text-xs text-gray-500">ä¾§æ å¯åˆ‡æ¢æ”»é˜?& ç‰¹å·¥</div>
          </div>
        </div>
        <LeafletMap
          mapIcon={getMapUrl()}
          activeTab={activeTab}
          lineups={mapLineups}
          selectedLineupId={selectedLineupId}
          onLineupSelect={setSelectedLineupId}
          newLineupData={newLineupData}
          setNewLineupData={setNewLineupData}
          placingType={placingType}
          setPlacingType={setPlacingType}
          selectedAgent={selectedAgent}
          selectedAbilityIndex={selectedAbilityIndex}
          onViewLineup={handleViewLineup}
          isFlipped={isFlipped}
          sharedLineup={sharedLineup}
        />
      </div>

      <RightPanel
        activeTab={activeTab}
        handleTabSwitch={handleTabSwitch}
        selectedSide={selectedSide}
        setSelectedSide={setSelectedSide}
        placingType={placingType}
        togglePlacingType={togglePlacingType}
        newLineupData={newLineupData}
        handleOpenEditor={handleOpenEditor}
        searchQuery={searchQuery}
        setSearchQuery={setSearchQuery}
        filteredLineups={filteredLineups}
        selectedLineupId={selectedLineupId}
        handleViewLineup={handleViewLineup}
        handleShare={handleShare}
        handleRequestDelete={handleRequestDelete}
        handleClearAll={handleClearAll}
        getMapDisplayName={getMapDisplayName}
        setIsPreviewModalOpen={setIsPreviewModalOpen}
      />

      <MapPickerModal
        isOpen={isMapModalOpen}
        maps={maps}
        selectedMap={selectedMap}
        setSelectedMap={setSelectedMap}
        setIsMapModalOpen={setIsMapModalOpen}
        getMapDisplayName={getMapDisplayName}
      />

      <PreviewModal
        isOpen={isPreviewModalOpen}
        previewInput={previewInput}
        setPreviewInput={setPreviewInput}
        onClose={() => setIsPreviewModalOpen(false)}
        onSubmit={handlePreviewSubmit}
      />

      <AlertModal message={alertMessage} onClose={() => setAlertMessage(null)} />

      <DeleteConfirmModal deleteTargetId={deleteTargetId} onCancel={() => setDeleteTargetId(null)} onConfirm={performDelete} />
      {isClearConfirmOpen && (
        <DeleteConfirmModal
          deleteTargetId="ALL"
          onCancel={() => setIsClearConfirmOpen(false)}
          onConfirm={performClearAll}
        />
      )}

      <EditorModal
        isEditorOpen={isEditorOpen}
        setIsEditorOpen={setIsEditorOpen}
        editingLineupId={editingLineupId}
        newLineupData={newLineupData}
        setNewLineupData={setNewLineupData}
        handleEditorSave={handleEditorSave}
      />

      <ViewerModal
        viewingLineup={viewingLineup}
        setViewingLineup={setViewingLineup}
        handleEditStart={handleEditStart}
        setViewingImage={setViewingImage}
        getMapDisplayName={getMapDisplayName}
        getMapEnglishName={getMapEnglishName}
      />

      <Lightbox viewingImage={viewingImage} setViewingImage={setViewingImage} />
    </div>
  );
}

export default App;
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';
import './index.css';
import 'leaflet/dist/leaflet.css';

ReactDOM.createRoot(document.getElementById('root') as HTMLElement).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
);
// @ts-nocheck
import React from 'react';
import Icon from './Icon';

const AlertModal = ({ message, onClose }) => {
  if (!message) return null;
  return (
    <div className="fixed inset-0 z-[1000] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
      <div className="modal-content bg-[#1f2326] border-l-4 border-[#ff4655] p-6 rounded shadow-2xl max-w-sm w-full">
        <div className="flex items-start gap-4">
          <div className="text-[#ff4655] mt-1">
            <Icon name="Info" size={24} />
          </div>
          <div className="flex-1">
            <h3 className="text-lg font-bold text-white mb-2">æç¤º</h3>
            <p className="text-gray-300 text-sm whitespace-pre-line">{message}</p>
          </div>
        </div>
        <div className="mt-6 flex justify-end">
          <button
            onClick={onClose}
            className="px-6 py-2 rounded bg-white/10 hover:bg-white/20 text-white text-sm font-bold transition-colors"
          >
            å…³é—­
          </button>
        </div>
      </div>
    </div>
  );
};

export default AlertModal;
// @ts-nocheck
import React from 'react';
import Icon from './Icon';

const DeleteConfirmModal = ({ deleteTargetId, onCancel, onConfirm }) => {
  if (!deleteTargetId) return null;
  return (
    <div className="fixed inset-0 z-[1000] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
      <div className="modal-content bg-[#1f2326] border-l-4 border-[#ff4655] p-6 rounded shadow-2xl max-w-sm w-full text-center">
        <div className="mx-auto w-12 h-12 bg-red-500/20 rounded-full flex items-center justify-center mb-4 text-[#ff4655]">
          <Icon name="AlertTriangle" size={24} />
        </div>
        <h3 className="text-xl font-bold text-white mb-2">ç¡®è®¤åˆ é™¤?</h3>
        <p className="text-gray-400 text-sm mb-6">æ­¤æ“ä½œæ— æ³•æ’¤é”€ã€?/p>
        <div className="flex gap-3 justify-center">
          <button onClick={onCancel} className="px-4 py-2 rounded bg-gray-700 hover:bg-gray-600 text-white text-sm font-bold transition-colors">
            å–æ¶ˆ
          </button>
          <button onClick={onConfirm} className="px-4 py-2 rounded bg-[#ff4655] hover:bg-[#d93a49] text-white text-sm font-bold transition-colors">
            ç¡®è®¤åˆ é™¤
          </button>
        </div>
      </div>
    </div>
  );
};

export default DeleteConfirmModal;
// @ts-nocheck
import React from 'react';
import Icon from './Icon';

const fields = [
  { k: 'stand', l: 'ç«™ä½å›? },
  { k: 'aim', l: 'ç„ç‚¹å›? },
  { k: 'aim2', l: 'ç„ç‚¹å›?' },
  { k: 'land', l: 'æŠ€èƒ½è½ç‚? },
];

const EditorModal = ({ isEditorOpen, setIsEditorOpen, editingLineupId, newLineupData, setNewLineupData, handleEditorSave }) => {
  if (!isEditorOpen) return null;
  return (
    <div className="fixed inset-0 z-[1000] bg-black/90 backdrop-blur-md flex items-center justify-center p-4">
      <div className="modal-content bg-[#1f2326] w-full max-w-3xl h-[85vh] flex flex-col rounded-xl border border-white/10 shadow-2xl">
        <div className="flex justify-between items-center p-6 border-b border-white/10 bg-[#252a30]">
          <h2 className="text-xl font-bold text-white uppercase tracking-wider flex items-center gap-3">
            <Icon name="FileText" className="text-[#ff4655]" /> {editingLineupId ? 'ç¼–è¾‘å›¾æ–‡ç­–ç•¥' : 'æ–°å¢å›¾æ–‡ç­–ç•¥'}
          </h2>
          <button onClick={() => setIsEditorOpen(false)} className="text-gray-400 hover:text-white">
            <Icon name="X" size={24} />
          </button>
        </div>
        <div className="flex-1 overflow-y-auto p-6 space-y-6">
          <div>
            <label className="text-xs font-bold text-gray-500 uppercase block mb-2">æ ‡é¢˜ (Title)</label>
            <input
              className="w-full bg-[#0f1923] border border-gray-700 rounded p-3 text-white focus:border-[#ff4655] outline-none"
              placeholder="ä¾‹å¦‚ï¼šBåŒºçª—æˆ·è¿›æ”»ç¬çˆ†çƒŸ"
              value={newLineupData.title}
              onChange={(e) => setNewLineupData({ ...newLineupData, title: e.target.value })}
              autoFocus
            />
          </div>
          <div className="grid grid-cols-2 gap-6">
            {fields.map((field) => (
              <div key={field.k} className="bg-[#181b1f] p-4 rounded border border-white/5">
                <div className="text-[#ff4655] font-bold text-sm mb-3 flex items-center gap-2 uppercase tracking-wider">
                  <Icon name="Image" size={14} /> {field.l}
                </div>
                <input
                  className="w-full bg-[#0f1923] border border-gray-700 rounded p-2 text-xs text-white focus:border-[#ff4655] outline-none mb-2"
                  placeholder="å›¾ç‰‡é“¾æ¥ (https://...)"
                  value={newLineupData[field.k + 'Img'] || ''}
                  onChange={(e) => setNewLineupData({ ...newLineupData, [field.k + 'Img']: e.target.value })}
                />
                <div className="h-32 bg-[#0f1923] rounded border border-gray-800 flex items-center justify-center overflow-hidden mb-2">
                  {newLineupData[field.k + 'Img'] ? (
                    <img src={newLineupData[field.k + 'Img']} className="w-full h-full object-cover" onError={(e) => (e.target.style.display = 'none')} />
                  ) : (
                    <span className="text-xs text-gray-600">é¢„è§ˆåŒºåŸŸ</span>
                  )}
                </div>
                <textarea
                  className="w-full bg-[#0f1923] border border-gray-700 rounded p-2 text-xs text-white focus:border-[#ff4655] outline-none resize-none h-16"
                  placeholder={`${field.l}è¯´æ˜...`}
                  value={newLineupData[field.k + 'Desc'] || ''}
                  onChange={(e) => setNewLineupData({ ...newLineupData, [field.k + 'Desc']: e.target.value })}
                />
              </div>
            ))}
          </div>
        </div>
        <div className="p-6 border-t border-white/10 bg-[#252a30] flex justify-end gap-3">
          <button onClick={() => setIsEditorOpen(false)} className="px-6 py-2 rounded bg-transparent hover:bg-white/5 text-gray-400 font-bold transition-colors">
            å–æ¶ˆ
          </button>
          <button onClick={handleEditorSave} className="px-8 py-2 rounded bg-[#ff4655] hover:bg-[#d93a49] text-white font-bold transition-colors shadow-lg">
            ç¡®è®¤ä¿å­˜
          </button>
        </div>
      </div>
    </div>
  );
};

export default EditorModal;
// @ts-nocheck
import React from 'react';
import * as lucideIcons from 'lucide-react';

export type IconName = keyof typeof lucideIcons;

const Icon: React.FC<{ name: IconName; size?: number; className?: string }> = ({
  name,
  size = 18,
  className = '',
}) => {
  const Lucide = lucideIcons[name];
  if (!Lucide) return null;
  return <Lucide size={size} className={className} />;
};

export default Icon;
// @ts-nocheck
import React, { useEffect, useRef, useState } from 'react';
import L from 'leaflet';

type Lineup = {
  id: string;
  agentPos?: { lat: number; lng: number };
  skillPos?: { lat: number; lng: number };
  agentIcon?: string;
  skillIcon?: string;
};

type Props = {
  mapIcon: string | null;
  activeTab: string;
  lineups: Lineup[];
  selectedLineupId: string | null;
  onLineupSelect: (id: string | null) => void;
  newLineupData: any;
  setNewLineupData: (fn: (prev: any) => any) => void;
  placingType: string | null;
  setPlacingType: (val: string | null) => void;
  selectedAgent: any;
  selectedAbilityIndex: number | null;
  onViewLineup?: (id: string) => void;
  isFlipped: boolean;
  sharedLineup: any;
};

const LeafletMap: React.FC<Props> = ({
  mapIcon,
  activeTab,
  lineups,
  selectedLineupId,
  onLineupSelect,
  newLineupData,
  setNewLineupData,
  placingType,
  setPlacingType,
  selectedAgent,
  selectedAbilityIndex,
  onViewLineup,
  isFlipped,
  sharedLineup,
}) => {
  const mapRef = useRef(null);
  const mapInstance = useRef<any>(null);
  const markerMap = useRef<Record<string, any>>({});
  const layers = useRef<{ activeLine: any; createLayer: any[] }>({ activeLine: null, createLayer: [] });
  const [hoveredLineupId, setHoveredLineupId] = useState<string | null>(null);
  const hoverLayer = useRef<any>(null);

  const transformPos = (pos: any) => {
    if (!pos) return null;
    if (isFlipped) {
      return { lat: 1000 - pos.lat, lng: 1000 - pos.lng };
    }
    return pos;
  };

  const inverseTransformPos = (pos: any) => {
    if (!pos) return null;
    if (isFlipped) {
      return { lat: 1000 - pos.lat, lng: 1000 - pos.lng };
    }
    return pos;
  };

  useEffect(() => {
    if (!mapRef.current) return;
    if (mapInstance.current) {
      mapInstance.current.remove();
      mapInstance.current = null;
    }
    mapRef.current.innerHTML = '';
    const map = L.map(mapRef.current, {
      crs: L.CRS.Simple,
      minZoom: -2,
      maxZoom: 2,
      zoomControl: false,
      attributionControl: false,
      zoomSnap: 0.1,
      wheelPxPerZoomLevel: 120,
    });
    mapInstance.current = map;
    return () => {
      if (mapInstance.current) {
        mapInstance.current.remove();
        mapInstance.current = null;
      }
    };
  }, []);

  useEffect(() => {
    const map = mapInstance.current;
    if (!map) return;
    const clickHandler = (e: any) => {
      L.DomEvent.preventDefault(e);
      L.DomEvent.stop(e);
      if (activeTab === 'create' && placingType) {
        const rawPos = { lat: e.latlng.lat, lng: e.latlng.lng };
        const standardPos = inverseTransformPos(rawPos);
        if (placingType === 'agent') setNewLineupData((prev: any) => ({ ...prev, agentPos: standardPos }));
        else setNewLineupData((prev: any) => ({ ...prev, skillPos: standardPos }));
      } else if (activeTab === 'view') {
        onLineupSelect(null);
      }
    };
    map.off('click');
    map.on('click', clickHandler);
    return () => map.off('click', clickHandler);
  }, [activeTab, placingType, setNewLineupData, onLineupSelect, isFlipped]);

  useEffect(() => {
    const map = mapInstance.current;
    if (!map || !mapIcon) return;
    map.eachLayer((l: any) => {
      if (l instanceof L.ImageOverlay) map.removeLayer(l);
    });
    const bounds: any = [
      [0, 0],
      [1000, 1000],
    ];
    L.imageOverlay(mapIcon, bounds).addTo(map);
    map.fitBounds(bounds);
  }, [mapIcon]);

  const createIcon = (type: 'agent' | 'skill', imgUrl?: string) => {
    const content = imgUrl
      ? `<div class="marker-icon-wrapper border-white"><img src="${imgUrl}" class="marker-img ${
          type === 'skill' ? 'marker-img-skill' : ''
        }"/></div>`
      : `<div class="marker-icon-wrapper bg-[#ff4655] text-white font-bold text-xs flex items-center justify-center">${
          type === 'agent' ? 'A' : 'S'
        }</div>`;
    return L.divIcon({ className: `custom-marker`, html: content, iconSize: [32, 32], iconAnchor: [16, 16] });
  };

  const updateMarkerStyle = (marker: any, isSelected: boolean, isInactive: boolean) => {
    const el = marker.getElement();
    if (!el) return;
    if (isSelected) {
      el.classList.add('marker-active');
      el.classList.remove('marker-inactive');
      marker.setZIndexOffset(1000);
    } else if (isInactive) {
      el.classList.remove('marker-active');
      el.classList.add('marker-inactive');
      marker.setZIndexOffset(0);
    } else {
      el.classList.remove('marker-active');
      el.classList.remove('marker-inactive');
      marker.setZIndexOffset(500);
    }
  };

  useEffect(() => {
    const map = mapInstance.current;
    if (!map) return;

    layers.current.createLayer.forEach((l) => map.removeLayer(l));
    layers.current.createLayer = [];

    if (activeTab === 'shared' && sharedLineup) {
      const l = sharedLineup;
      const viewAgentPos = transformPos(l.agentPos);
      const viewSkillPos = transformPos(l.skillPos);
      if (viewAgentPos && viewSkillPos) {
        L.marker(viewAgentPos, { icon: createIcon('agent', l.agentIcon) }).addTo(map);
        L.marker(viewSkillPos, { icon: createIcon('skill', l.skillIcon) }).addTo(map);
        L.polyline([viewAgentPos, viewSkillPos], { color: '#ff4655', weight: 3, dashArray: '8, 8' }).addTo(map);
      }
      return;
    }

    if (activeTab === 'create') {
      const { agentPos, skillPos } = newLineupData;
      const currentAgentIcon = selectedAgent?.displayIcon || null;
      const currentSkillIcon =
        selectedAgent && selectedAbilityIndex !== null ? selectedAgent.abilities[selectedAbilityIndex]?.displayIcon : null;

      const viewAgentPos = transformPos(agentPos);
      const viewSkillPos = transformPos(skillPos);

      const onDragEnd = (type: 'agent' | 'skill') => (e: any) => {
        const rawPos = { lat: e.target.getLatLng().lat, lng: e.target.getLatLng().lng };
        const standardPos = inverseTransformPos(rawPos);
        if (type === 'agent') setNewLineupData((prev: any) => ({ ...prev, agentPos: standardPos }));
        else setNewLineupData((prev: any) => ({ ...prev, skillPos: standardPos }));
      };

      if (viewAgentPos) {
        const m = L.marker(viewAgentPos, { icon: createIcon('agent', currentAgentIcon), draggable: true, keyboard: false }).addTo(map);
        m.on('dragend', onDragEnd('agent'));
        layers.current.createLayer.push(m);
      }
      if (viewSkillPos) {
        const m = L.marker(viewSkillPos, { icon: createIcon('skill', currentSkillIcon), draggable: true, keyboard: false }).addTo(map);
        m.on('dragend', onDragEnd('skill'));
        layers.current.createLayer.push(m);
      }
      if (viewAgentPos && viewSkillPos) {
        const l = L.polyline([viewAgentPos, viewSkillPos], { color: '#ff4655', weight: 3, dashArray: '8, 8' }).addTo(map);
        layers.current.createLayer.push(l);
      }

      Object.values(markerMap.current).forEach(({ agent, skill }) => {
        map.removeLayer(agent);
        map.removeLayer(skill);
      });
      markerMap.current = {};
      if (layers.current.activeLine) {
        map.removeLayer(layers.current.activeLine);
        layers.current.activeLine = null;
      }
    } else {
      Object.values(markerMap.current).forEach(({ agent, skill }) => {
        map.removeLayer(agent);
        map.removeLayer(skill);
      });
      markerMap.current = {};

      lineups.forEach((l) => {
        const viewAgentPos = transformPos(l.agentPos);
        const viewSkillPos = transformPos(l.skillPos);
        if (!viewAgentPos || !viewSkillPos) return;

        const am = L.marker(viewAgentPos, { icon: createIcon('agent', l.agentIcon), keyboard: false }).addTo(map);
        const sm = L.marker(viewSkillPos, { icon: createIcon('skill', l.skillIcon), keyboard: false }).addTo(map);

        const handler = (e: any) => {
          L.DomEvent.preventDefault(e);
          L.DomEvent.stop(e);
          onLineupSelect(l.id);
          if (onViewLineup) onViewLineup(l.id);
        };
        am.on('click', handler);
        sm.on('click', handler);
        am.on('mouseover', () => setHoveredLineupId(l.id));
        am.on('mouseout', () => setHoveredLineupId(null));
        sm.on('mouseover', () => setHoveredLineupId(l.id));
        sm.on('mouseout', () => setHoveredLineupId(null));

        markerMap.current[l.id] = { agent: am, skill: sm, data: l, viewAgentPos, viewSkillPos };
        const isSelected = l.id === selectedLineupId;
        const isInactive = selectedLineupId && !isSelected;
        updateMarkerStyle(am, isSelected, isInactive);
        updateMarkerStyle(sm, isSelected, isInactive);
        if (isSelected) {
          const line = L.polyline([viewAgentPos, viewSkillPos], { color: '#ff4655', weight: 3, dashArray: '8, 8' }).addTo(map);
          layers.current.activeLine = line;
        }
      });
    }
  }, [lineups, activeTab, newLineupData, selectedAgent, selectedAbilityIndex, isFlipped, sharedLineup]);

  useEffect(() => {
    const map = mapInstance.current;
    if (!map || activeTab !== 'view') return;
    if (layers.current.activeLine) {
      map.removeLayer(layers.current.activeLine);
      layers.current.activeLine = null;
    }
    Object.keys(markerMap.current).forEach((id) => {
      const { agent, skill, viewAgentPos, viewSkillPos } = markerMap.current[id];
      const isSelected = id === selectedLineupId;
      const isInactive = selectedLineupId && !isSelected;
      updateMarkerStyle(agent, isSelected, isInactive);
      updateMarkerStyle(skill, isSelected, isInactive);
      if (isSelected) {
        const line = L.polyline([viewAgentPos, viewSkillPos], { color: '#ff4655', weight: 3, dashArray: '8, 8' }).addTo(map);
        layers.current.activeLine = line;
      }
    });
  }, [selectedLineupId, activeTab]);

  useEffect(() => {
    const map = mapInstance.current;
    if (!map) return;
    if (hoverLayer.current) {
      map.removeLayer(hoverLayer.current);
      hoverLayer.current = null;
    }
    if (hoveredLineupId && activeTab === 'view') {
      const lineup = lineups.find((l) => l.id === hoveredLineupId);
      if (lineup && lineup.agentPos && lineup.skillPos && lineup.id !== selectedLineupId) {
        const viewAgentPos = transformPos(lineup.agentPos);
        const viewSkillPos = transformPos(lineup.skillPos);
        const line = L.polyline([viewAgentPos, viewSkillPos], { color: 'white', weight: 2, dashArray: '5, 5', opacity: 0.7 }).addTo(map);
        hoverLayer.current = line;
      }
    }
  }, [hoveredLineupId, lineups, activeTab, selectedLineupId, isFlipped]);

  return <div ref={mapRef} className="w-full h-full z-0 outline-none" />;
};

export default React.memo(LeafletMap);
// @ts-nocheck
import React from 'react';
import Icon from './Icon';

type Props = {
  activeTab: string;
  selectedMap: any;
  setIsMapModalOpen: (val: boolean) => void;
  selectedSide: string;
  setSelectedSide: (val: string) => void;
  selectedAgent: any;
  setSelectedAgent: (agent: any) => void;
  agents: any[];
  agentCounts: Record<string, number>;
  selectedAbilityIndex: number | null;
  setSelectedAbilityIndex: (idx: number | null) => void;
  setIsPreviewModalOpen: (v: boolean) => void;
  getMapDisplayName: (name: string) => string;
};

const LeftPanel: React.FC<Props> = ({
  activeTab,
  selectedMap,
  setIsMapModalOpen,
  selectedSide,
  setSelectedSide,
  selectedAgent,
  setSelectedAgent,
  agents,
  agentCounts,
  selectedAbilityIndex,
  setSelectedAbilityIndex,
  setIsPreviewModalOpen,
  getMapDisplayName,
}) => {
  const handleAgentClick = (agent: any) => {
    if (selectedAgent?.uuid === agent.uuid) {
      if (activeTab === 'view') setSelectedAgent(null);
    } else {
      setSelectedAgent(agent);
      setSelectedAbilityIndex(null);
    }
  };

  return (
    <div className="w-80 flex-shrink-0 flex flex-col bg-[#1f2326] border-r border-white/10 z-20 shadow-2xl">
      <div className="h-16 flex items-center px-6 border-b border-white/5 bg-[#1f2326] shadow-sm flex justify-between">
        <div className="flex items-center gap-3">
          <img src="/brand-logo.svg" alt="Logo" className="w-[168px] h-[32px]" />
        </div>
      </div>

      <div className="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-6">
        <div>
          <div className="flex justify-between items-center mb-2">
            <label className="text-[12px] font-bold text-gray-500 uppercase tracking-wider">å½“å‰åœ°å›¾ (Map)</label>
          </div>
          {selectedMap && (
            <div
              onClick={() => setIsMapModalOpen(true)}
              className="group relative h-28 w-full rounded-lg overflow-hidden border border-white/20 cursor-pointer hover:border-[#ff4655] transition-all shadow-lg"
            >
              <img src={selectedMap.listViewIcon} alt={selectedMap.displayName} className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" />
              <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-black/20 to-transparent flex items-end p-4">
                <span className="font-bold text-xl uppercase tracking-widest text-white drop-shadow-md">{getMapDisplayName(selectedMap.displayName)}</span>
              </div>
            </div>
          )}
        </div>

        <div>
          <div className="flex justify-between items-center mb-2">
            <label className="text-[12px] font-bold text-gray-500 uppercase tracking-wider">é€‰æ‹©ç‰¹å·¥ (Agent)</label>
            {activeTab === 'view' && selectedAgent && (
              <button onClick={() => setSelectedAgent(null)} className="text-[12px] text-gray-500 hover:text-white">æ˜¾ç¤ºå…¨éƒ¨</button>
            )}
          </div>
          <div className="grid grid-cols-4 gap-2">
            {agents.map((agent) => {
              const count = agentCounts[agent.displayName] || 0;
              return (
                <div
                  key={agent.uuid}
                  onClick={() => handleAgentClick(agent)}
                  className={`agent-item aspect-square rounded cursor-pointer overflow-hidden relative border-2 ${selectedAgent?.uuid === agent.uuid ? 'selected border-[#ff4655]' : 'border-transparent bg-[#0f1923]'}`}
                  title={agent.displayName}
                >
                  <img src={agent.displayIcon} alt={agent.displayName} className="w-full h-full object-cover" />
                  {activeTab === 'view' && <span className={`count-badge ${count > 0 ? 'count-has-data' : 'count-empty'}`}>{count}</span>}
                </div>
              );
            })}
          </div>
        </div>

        {selectedAgent && (
          <div className="animate-in fade-in slide-in-from-top-2 duration-300">
            <label className="text-[12px] font-bold text-gray-500 uppercase tracking-wider mb-2 block">
              {activeTab === 'create' ? 'é€‰æ‹©ä½¿ç”¨æŠ€èƒ?(Ability)' : 'æŒ‰æŠ€èƒ½ç­›é€?(Filter by Ability)'}
            </label>
            <div className="flex gap-2 justify-between bg-[#0f1923] p-2 rounded-lg border border-white/10">
              {selectedAgent.abilities
                .filter((a: any) => a.slot !== 'Passive')
                .map((ability: any, idx: number) => (
                  <button
                    key={idx}
                    onClick={() => setSelectedAbilityIndex(selectedAbilityIndex === idx ? null : idx)}
                    className={`ability-icon flex flex-col items-center gap-1 flex-1 p-1 rounded ${selectedAbilityIndex === idx ? 'selected bg-white/5' : ''}`}
                    title={ability.displayName}
                  >
                    <img src={ability.displayIcon} className="w-8 h-8 object-contain" />
                    <span className="text-[8px] uppercase font-bold text-gray-500">{ability.slot}</span>
                  </button>
                ))}
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default LeftPanel;
// @ts-nocheck
import React from 'react';
import Icon from './Icon';

const Lightbox = ({ viewingImage, setViewingImage }) => {
  if (!viewingImage) return null;
  return (
    <div className="fixed inset-0 z-[2000] bg-black/95 flex items-center justify-center p-4 cursor-zoom-out" onClick={() => setViewingImage(null)}>
      <img src={viewingImage} className="lightbox-img rounded" onClick={(e) => e.stopPropagation()} />
      <button
        className="absolute top-6 right-6 w-12 h-12 flex items-center justify-center bg-black/60 hover:bg-[#ff4655] rounded-full text-white transition-all backdrop-blur-md border border-white/20"
        onClick={(e) => {
          e.stopPropagation();
          setViewingImage(null);
        }}
      >
        <Icon name="X" size={28} />
      </button>
    </div>
  );
};

export default Lightbox;
// @ts-nocheck
import React from 'react';
import Icon from './Icon';

const MapPickerModal = ({ isOpen, maps, selectedMap, setSelectedMap, setIsMapModalOpen, getMapDisplayName }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 z-[999] bg-black/90 backdrop-blur-sm flex items-center justify-center p-8 animate-in fade-in">
      <div className="w-full max-w-6xl max-h-full flex flex-col">
        <div className="flex justify-between items-center mb-6">
          <h2 className="text-2xl font-bold uppercase tracking-widest text-white">
            é€‰æ‹©åœ°å›¾ <span className="text-[#ff4655]">SELECT MAP</span>
          </h2>
          <button onClick={() => setIsMapModalOpen(false)} className="text-white hover:text-[#ff4655]">
            <Icon name="X" size={32} />
          </button>
        </div>
        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 overflow-y-auto pb-4">
          {maps.map((m) => (
            <div
              key={m.uuid}
              onClick={() => {
                setSelectedMap(m);
                setIsMapModalOpen(false);
              }}
              className={`map-card relative aspect-video rounded-xl overflow-hidden border-2 cursor-pointer ${
                selectedMap?.uuid === m.uuid ? 'border-[#ff4655]' : 'border-transparent'
              }`}
            >
              <img src={m.listViewIcon} loading="lazy" className="w-full h-full object-cover" />
              <div className="absolute inset-0 bg-black/40 hover:bg-transparent transition-colors flex items-center justify-center">
                <span className="font-bold text-[2.2rem] leading-tight uppercase tracking-widest drop-shadow-lg text-center">
                  {getMapDisplayName(m.displayName)}
                </span>
              </div>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
};

export default MapPickerModal;
// @ts-nocheck
import React from 'react';

const PreviewModal = ({ isOpen, previewInput, setPreviewInput, onClose, onSubmit }) => {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 z-[1000] bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
      <div className="modal-content bg-[#1f2326] border-l-4 border-[#ff4655] p-6 rounded shadow-2xl max-w-md w-full">
        <h3 className="text-lg font-bold text-white mb-4">åŠ è½½åˆ†äº«ç‚¹ä½</h3>
        <input
          className="w-full bg-[#0f1923] border border-gray-600 rounded p-3 text-white focus:border-[#ff4655] outline-none mb-4"
          placeholder="ç²˜è´´åˆ†äº«é“¾æ¥æˆ–ID..."
          value={previewInput}
          onChange={(e) => setPreviewInput(e.target.value)}
        />
        <div className="flex justify-end gap-3">
          <button onClick={onClose} className="px-4 py-2 rounded bg-transparent hover:bg-white/5 text-gray-400 text-sm font-bold transition-colors">
            å–æ¶ˆ
          </button>
          <button onClick={onSubmit} className="px-6 py-2 rounded bg-[#ff4655] hover:bg-[#d93a49] text-white text-sm font-bold transition-colors">
            åŠ è½½é¢„è§ˆ
          </button>
        </div>
      </div>
    </div>
  );
};

export default PreviewModal;
// @ts-nocheck
import React from 'react';
import Icon from './Icon';

type Props = {
  activeTab: string;
  handleTabSwitch: (tab: string) => void;
  selectedSide: string;
  setSelectedSide: (v: string) => void;
  placingType: string | null;
  togglePlacingType: (type: string) => void;
  newLineupData: any;
  handleOpenEditor: () => void;
  searchQuery: string;
  setSearchQuery: (v: string) => void;
  filteredLineups: any[];
  selectedLineupId: string | null;
  handleViewLineup: (id: string) => void;
  handleShare: (id: string, e: any) => void;
  handleRequestDelete: (id: string, e: any) => void;
  handleClearAll: () => void;
  getMapDisplayName: (name: string) => string;
  setIsPreviewModalOpen: (v: boolean) => void;
};

const RightPanel: React.FC<Props> = ({
  activeTab,
  handleTabSwitch,
  selectedSide,
  setSelectedSide,
  placingType,
  togglePlacingType,
  newLineupData,
  handleOpenEditor,
  searchQuery,
  setSearchQuery,
  filteredLineups,
  selectedLineupId,
  handleViewLineup,
  handleShare,
  handleRequestDelete,
  handleClearAll,
  getMapDisplayName,
  setIsPreviewModalOpen,
}) => {
  return (
    <div className="w-96 flex-shrink-0 flex flex-col bg-[#1f2326] border-l border-white/10 z-20 shadow-2xl">
      <div className="flex border-b border-white/10">
        <button
          onClick={() => handleTabSwitch('view')}
          className={`flex-1 py-4 flex items-center justify-center gap-2 font-bold uppercase tracking-wider transition-colors ${
            activeTab === 'view' ? 'bg-[#ff4655] text-white' : 'text-gray-400 hover:text-white hover:bg-white/5'
          }`}
        >
          <Icon name="Search" size={18} /> æŸ¥çœ‹ç‚¹ä½
        </button>
        <button
          onClick={() => handleTabSwitch('create')}
          className={`flex-1 py-4 flex items-center justify-center gap-2 font-bold uppercase tracking-wider transition-colors ${
            activeTab === 'create' ? 'bg-[#ff4655] text-white' : 'text-gray-400 hover:text-white hover:bg-white/5'
          }`}
        >
          <Icon name="Plus" size={18} /> æ–°å¢ç‚¹ä½
        </button>
        <button
          onClick={() => setIsPreviewModalOpen(true)}
          className="py-4 px-4 flex items-center justify-center border-l border-white/10 text-gray-400 hover:text-white hover:bg-white/5 transition-colors"
          title="åŠ è½½åˆ†äº«é“¾æ¥"
        >
          <Icon name="Link" size={18} />
        </button>
      </div>

      <div className="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-6">
        {activeTab === 'create' ? (
          <div className="space-y-6 animate-in fade-in">
            <div>
              <label className="text-[12px] font-bold text-[#ff4655] uppercase tracking-wider block mb-3">
                1. æ”»é˜²é€‰æ‹© (Side) <span className="text-red-500">*</span>
              </label>
              <div className="flex bg-[#0f1923] p-1 rounded-lg border border-white/10 h-12">
                <button
                  onClick={() => setSelectedSide('attack')}
                  className={`flex-1 rounded-md text-sm font-bold flex items-center justify-center gap-2 transition-all border ${
                    selectedSide === 'attack' ? 'bg-red-500/20 text-red-400 border-red-500/50 shadow' : 'text-gray-500 border-transparent hover:text-red-400'
                  }`}
                >
                  <Icon name="Sword" size={18} /> è¿›æ”»
                </button>
                <button
                  onClick={() => setSelectedSide('defense')}
                  className={`flex-1 rounded-md text-sm font-bold flex items-center justify-center gap-2 transition-all border ${
                    selectedSide === 'defense' ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/50 shadow' : 'text-gray-500 border-transparent hover:text-emerald-400'
                  }`}
                >
                  <Icon name="Shield" size={18} /> é˜²å®ˆ
                </button>
              </div>
            </div>

            <div>
              <label className="text-[12px] font-bold text-[#ff4655] uppercase tracking-wider block mb-3">2. åœ°å›¾æ ‡æ³¨å·¥å…·</label>
              <div className="grid grid-cols-2 gap-3">
                <button
                  onClick={() => togglePlacingType('agent')}
                  className={`p-4 rounded-lg border flex flex-col items-center gap-2 transition-all ${
                    newLineupData.agentPos
                      ? 'bg-emerald-500/10 border-emerald-500 text-emerald-500'
                      : placingType === 'agent'
                      ? 'bg-[#ff4655] text-white border-transparent'
                      : 'bg-[#0f1923] border-gray-700 text-gray-400 hover:border-gray-500'
                  }`}
                >
                  <Icon name="User" size={24} />
                  <span className="text-xs font-bold">{newLineupData.agentPos ? 'ç«™ä½å·²å®š' : 'è®¾ç½®ç«™ä½'}</span>
                </button>
                <button
                  onClick={() => togglePlacingType('skill')}
                  className={`p-4 rounded-lg border flex flex-col items-center gap-2 transition-all ${
                    newLineupData.skillPos
                      ? 'bg-emerald-500/10 border-emerald-500 text-emerald-500'
                      : placingType === 'skill'
                      ? 'bg-[#ff4655] text-white border-transparent'
                      : 'bg-[#0f1923] border-gray-700 text-gray-400 hover:border-gray-500'
                  }`}
                >
                  <Icon name="Target" size={24} />
                  <span className="text-xs font-bold">{newLineupData.skillPos ? 'è½ç‚¹å·²å®š' : 'è®¾ç½®è½ç‚¹'}</span>
                </button>
              </div>
              <p className="text-[12px] text-gray-500 mt-2 text-center">{placingType ? 'è¯·åœ¨åœ°å›¾ä¸Šç‚¹å‡»ä½ç½?..' : 'ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹æ ‡æ³?}</p>
            </div>

            <div>
              <label className="text-[12px] font-bold text-[#ff4655] uppercase tracking-wider block mb-3">3. å›¾æ–‡è¯¦æƒ…</label>
              <button
                onClick={handleOpenEditor}
                className="w-full bg-[#ff4655] hover:bg-[#d93a49] text-white font-bold py-4 rounded-lg flex items-center justify-center gap-2 transition-colors uppercase tracking-wider shadow-lg shadow-red-900/20 group"
              >
                <Icon name="FileText" size={20} className="group-hover:scale-110 transition-transform" />
                å¡«å†™å›¾æ–‡æ”»ç•¥
              </button>
              <p className="text-[12px] text-gray-500 mt-2 text-center">æ·»åŠ æ ‡é¢˜ã€è¯´æ˜å’Œæˆªå›¾</p>
            </div>
          </div>
        ) : (
          <div className="h-full flex flex-col">
            <div className="relative mb-4">
              <input
                type="text"
                placeholder="æœç´¢ç‚¹ä½æ ‡é¢˜..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="w-full bg-[#0f1923] border border-gray-700 rounded-lg py-3 pl-10 pr-4 text-sm text-white focus:border-[#ff4655] outline-none transition-colors"
              />
              <div className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-500">
                <Icon name="Search" size={16} />
              </div>
            </div>

            <div className="flex-1 overflow-y-auto space-y-2 pr-1">
              {/* Side filter in view mode */}
              <div className="flex bg-[#0f1923] p-1 rounded-lg border border-white/10 mb-3">
                <button onClick={() => setSelectedSide('all')} className={`flex-1 py-2 rounded text-xs font-bold transition-all border ${selectedSide === 'all' ? 'bg-gray-600 text-white border-gray-500 shadow' : 'text-gray-500 border-transparent hover:text-white'}`}>å…¨éƒ¨</button>
                <button onClick={() => setSelectedSide('attack')} className={`flex-1 py-2 rounded text-xs font-bold flex items-center justify-center gap-1 transition-all border ${selectedSide === 'attack' ? 'bg-red-500/20 text-red-400 border-red-500/50 shadow' : 'text-gray-500 border-transparent hover:text-red-400'}`}><Icon name="Sword" size={14} /> è¿›æ”»</button>
                <button onClick={() => setSelectedSide('defense')} className={`flex-1 py-2 rounded text-xs font-bold flex items-center justify-center gap-1 transition-all border ${selectedSide === 'defense' ? 'bg-emerald-500/20 text-emerald-400 border-emerald-500/50 shadow' : 'text-gray-500 border-transparent hover:text-emerald-400'}`}><Icon name="Shield" size={14} /> é˜²å®ˆ</button>
              </div>
              {filteredLineups.length === 0 ? (
                <div className="flex flex-col items-center justify-center h-64 text-gray-500">
                  <Icon name="Search" size={48} className="mb-2 opacity-20" />
                  <span className="text-xs">æš‚æ— ç›¸å…³ç‚¹ä½</span>
                </div>
              ) : (
                filteredLineups.map((l) => (
                  <div
                    key={l.id}
                    onClick={() => handleViewLineup(l.id)}
                    className={`group p-4 rounded-lg border cursor-pointer transition-all flex items-center gap-4 ${
                      selectedLineupId === l.id ? 'bg-[#ff4655]/10 border-[#ff4655] shadow-md' : 'bg-[#0f1923] border-white/5 hover:border-white/20'
                    }`}
                  >
                    <div className="relative">
                      {l.agentIcon ? (
                        <img src={l.agentIcon} className="w-10 h-10 rounded-full border border-white/10" />
                      ) : (
                        <div className="w-10 h-10 rounded-full bg-gray-700 flex items-center justify-center text-xs">{l.agentName?.[0]}</div>
                      )}
                      {l.skillIcon && <img src={l.skillIcon} className="absolute -bottom-1 -right-1 w-5 h-5 bg-[#1f2326] rounded-full p-0.5 border border-white/20" />}
                    </div>
                    <div className="flex-1 min-w-0">
                      <div className="flex justify-between gap-2 items-center mb-1">
                        <h4 className={`text-sm font-bold truncate ${selectedLineupId === l.id ? 'text-[#ff4655]' : 'text-white'}`}>{l.title}</h4>
                        <div className="flex gap-1 text-[12px] text-gray-500 shrink-0">
                          <span>{getMapDisplayName(l.mapName)}</span>
                          <span>Â·</span>
                          <span>{l.agentName}</span>
                        </div>
                      </div>
                      <div className="flex justify-between items-center">
                        <span
                          className={`text-[9px] uppercase font-bold px-1.5 py-0.5 rounded border ${
                            l.side === 'attack'
                              ? 'text-red-400 border-red-500/30 bg-red-500/10'
                              : 'text-emerald-400 border-emerald-500/30 bg-emerald-500/10'
                          }`}
                        >
                          {l.side === 'attack' ? 'è¿›æ”»' : 'é˜²å®ˆ'}
                        </span>
                        <div className="flex gap-1">
                          <button
                            onClick={(e) => handleShare(l.id, e)}
                            className="text-gray-600 hover:text-blue-400 p-1 rounded hover:bg-white/5 transition-colors"
                            title="åˆ†äº«"
                          >
                            <Icon name="Share2" size={14} />
                          </button>
                          <button
                            onClick={(e) => handleRequestDelete(l.id, e)}
                            className="text-gray-600 hover:text-red-500 p-1 rounded hover:bg-white/5 transition-colors"
                            title="åˆ é™¤"
                          >
                            <Icon name="Trash2" size={14} />
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                ))
              )}
            </div>

            <div className="mt-3">
              <button
                onClick={handleClearAll}
                className="w-full bg-[#ff4655] hover:bg-[#d93a49] text-white font-bold py-4 rounded-lg flex items-center justify-center gap-2 transition-colors uppercase tracking-wider shadow-lg shadow-red-900/20 group"
              >
                <Icon name="Trash2" size={20} className="group-hover:scale-110 transition-transform" />
                ä¸€é”®æ¸…ç©ºæˆ‘çš„ç‚¹ä½?              </button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default RightPanel;
// @ts-nocheck
import React from 'react';
import Icon from './Icon';

const ViewerModal = ({ viewingLineup, setViewingLineup, handleEditStart, setViewingImage, getMapDisplayName, getMapEnglishName }) => {
  if (!viewingLineup) return null;
  return (
    <div className="fixed inset-0 z-[1000] bg-black/90 backdrop-blur-md flex items-center justify-center p-4">
      <div className="modal-content bg-[#1f2326] w-full max-w-4xl max-h-[90vh] flex flex-col rounded-xl border border-white/10 shadow-2xl overflow-hidden relative">
        <button
          type="button"
          onClick={() => setViewingLineup(null)}
          className="absolute top-4 right-4 w-8 h-8 flex items-center justify-center bg-black/60 hover:bg-[#ff4655] rounded-full text-white transition-all z-20 backdrop-blur-sm border border-white/10"
          title="å…³é—­"
        >
          <Icon name="X" size={18} />
        </button>
        <button
          type="button"
          onClick={() => handleEditStart(viewingLineup)}
          className="absolute top-4 right-16 w-8 h-8 flex items-center justify-center bg-black/60 hover:bg-[#ff4655] rounded-full text-white transition-all z-20 backdrop-blur-sm border border-white/10"
          title="ç¼–è¾‘"
        >
          <Icon name="Pencil" size={16} />
        </button>

        <div className="p-6 border-b border-white/10 bg-[#252a30]">
          <div className="flex items-center gap-3 mb-1">
            <span
              className={`text-[12px] font-bold px-2 py-0.5 rounded ${
                viewingLineup.side === 'attack' ? 'bg-red-500/20 text-red-400' : 'bg-emerald-500/20 text-emerald-400'
              }`}
            >
              {viewingLineup.side === 'attack' ? 'è¿›æ”» (ATK)' : 'é˜²å®ˆ (DEF)'}
            </span>
            <span className="text-[12px] text-gray-500 font-mono">
              {getMapDisplayName(getMapEnglishName(viewingLineup.mapName))}
            </span>
          </div>
          <div className="flex items-center justify-between">
            <h2 className="text-2xl font-bold text-white tracking-tight">{viewingLineup.title}</h2>
            <div className="flex items-center gap-2 opacity-50">
              {viewingLineup.agentIcon && <img src={viewingLineup.agentIcon} className="w-6 h-6 rounded-full" />}
              <span className="text-xs font-bold text-white">{viewingLineup.agentName}</span>
            </div>
          </div>
        </div>

        <div className="flex-1 overflow-y-auto p-6 bg-[#181b1f]">
          <div className="grid grid-cols-2 gap-6">
            {[
              { src: viewingLineup.standImg, desc: viewingLineup.standDesc, label: '1. ç«™ä½ (Stand)' },
              { src: viewingLineup.aimImg, desc: viewingLineup.aimDesc, label: '2. ç„ç‚¹ 1 (Aim)' },
              { src: viewingLineup.aim2Img, desc: viewingLineup.aim2Desc, label: '3. ç„ç‚¹ 2 (Aim)' },
              { src: viewingLineup.landImg, desc: viewingLineup.landDesc, label: '4. è½ç‚¹ (Land)' },
            ].map((item, idx) =>
              item.src ? (
                <div key={idx} className="flex flex-col gap-2">
                  <div className="text-[#ff4655] font-bold text-xs uppercase tracking-wider">{item.label}</div>
                  <div
                    className="relative group cursor-zoom-in aspect-video bg-[#0f1923] rounded-lg overflow-hidden border border-white/10 hover:border-[#ff4655] transition-colors"
                    onClick={() => setViewingImage(item.src)}
                  >
                    <img src={item.src} className="w-full h-full object-cover" />
                    <div className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                      <Icon name="Maximize2" className="text-white" />
                    </div>
                  </div>
                  {item.desc && <div className="text-xs text-gray-300 bg-black/20 p-2 rounded border border-white/5">{item.desc}</div>}
                </div>
              ) : null,
            )}
          </div>
          {!viewingLineup.standImg && !viewingLineup.aimImg && !viewingLineup.aim2Img && !viewingLineup.landImg && (
            <div className="h-full flex items-center justify-center text-gray-500 text-sm">æš‚æ— å›¾ç‰‡èµ„æ–™</div>
          )}
        </div>
      </div>
    </div>
  );
};

export default ViewerModal;
