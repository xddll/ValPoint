# æŠ€æœ¯æ¶æ„

ValPoint é‡‡ç”¨ç°ä»£åŒ–çš„å‰åç«¯åˆ†ç¦»æ¶æ„ï¼ŒåŸºäº `React + Supabase` æ„å»ºã€‚

## ğŸ—ï¸ å‰ç«¯æ¶æ„
### æŠ€æœ¯æ ˆ

| æŠ€æœ¯ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|
| React | 18.x | UI æ¡†æ¶ |
| TypeScript | 5.x | ç±»å‹ç³»ç»Ÿ |
| Vite | 5.x | æ„å»ºå·¥å…· |
| Tailwind CSS | 3.x | æ ·å¼æ¡†æ¶ |
| Leaflet | 1.9.x | åœ°å›¾åº“ |
| Lucide React | - | å›¾æ ‡åº“ |

### ç›®å½•ç»“æ„

```
src/
â”œâ”€â”€ components/          # React ç»„ä»¶
â”‚   â”œâ”€â”€ EditorModal.tsx  # ç¼–è¾‘å™¨æ¨¡æ€æ¡†
â”‚   â”œâ”€â”€ ViewerModal.tsx  # æŸ¥çœ‹å™¨æ¨¡æ€æ¡†
â”‚   â”œâ”€â”€ LeafletMap.tsx   # åœ°å›¾ç»„ä»¶
â”‚   â”œâ”€â”€ LeftPanel.tsx    # å·¦ä¾§é¢æ¿
â”‚   â”œâ”€â”€ RightPanel.tsx   # å³ä¾§é¢æ¿
â”‚   â””â”€â”€ Icon.tsx         # å›¾æ ‡ç»„ä»¶
â”‚
â”œâ”€â”€ hooks/               # è‡ªå®šä¹‰ Hooks
â”‚   â”œâ”€â”€ useValorantData.ts    # åœ°å›¾/è‹±é›„æ•°æ®
â”‚   â”œâ”€â”€ useLineups.ts         # ä¸ªäººåº“æ•°æ®
â”‚   â”œâ”€â”€ useSharedLineups.ts   # å…±äº«åº“æ•°æ®
â”‚   â”œâ”€â”€ useShareActions.ts    # åˆ†äº«/å¤åˆ¶æ“ä½œ
â”‚   â””â”€â”€ useLineupActions.ts   # CRUD æ“ä½œ
â”‚
â”œâ”€â”€ utils/               # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ authorFetcher.ts # ä½œè€…ä¿¡æ¯è·å–
â”‚   â”œâ”€â”€ ossUpload.ts     # å›¾åºŠä¸Šä¼ 
â”‚   â””â”€â”€ abilityIcons.ts  # æŠ€èƒ½å›¾æ ‡å¤„ç†
â”‚
â”œâ”€â”€ constants/           # å¸¸é‡é…ç½®
â”‚   â””â”€â”€ maps.ts          # åœ°å›¾é…ç½®
â”‚
â”œâ”€â”€ data/                # é™æ€æ•°æ®
â”‚   â””â”€â”€ ability_overrides.json  # æŠ€èƒ½è¦†ç›–æ•°æ®
â”‚
â”œâ”€â”€ services/            # æœåŠ¡å±‚
â”‚   â””â”€â”€ tables.ts        # è¡¨åå¸¸é‡
â”‚
â”œâ”€â”€ types/               # TypeScript ç±»å‹
â”‚   â””â”€â”€ database.ts      # æ•°æ®åº“ç±»å‹
â”‚
â”œâ”€â”€ lib/                 # ç¬¬ä¸‰æ–¹åº“å°è£…
â”‚   â””â”€â”€ imageCompression.ts  # å›¾ç‰‡å‹ç¼©
â”‚
â”œâ”€â”€ App.tsx              # åº”ç”¨å…¥å£
â”œâ”€â”€ main.tsx             # ä¸»å…¥å£
â”œâ”€â”€ index.css            # å…¨å±€æ ·å¼
â””â”€â”€ supabaseClient.ts    # Supabase å®¢æˆ·ç«¯
```

### ç»„ä»¶å±‚æ¬¡

```
App.tsx
â”œâ”€â”€ LeftPanel
â”‚   â”œâ”€â”€ MapSelector
â”‚   â”œâ”€â”€ AgentSelector
â”‚   â””â”€â”€ FilterPanel
â”‚
â”œâ”€â”€ LeafletMap
â”‚   â””â”€â”€ Markers
â”‚
â”œâ”€â”€ RightPanel
â”‚   â”œâ”€â”€ LineupList
â”‚   â”‚   â””â”€â”€ LineupCard
â”‚   â””â”€â”€ ActionButtons
â”‚
â”œâ”€â”€ EditorModal
â”‚   â”œâ”€â”€ ImageUploader
â”‚   â”œâ”€â”€ SourceLinkInput
â”‚   â””â”€â”€ MapSelector
â”‚
â””â”€â”€ ViewerModal
    â”œâ”€â”€ ImageGallery
    â””â”€â”€ AuthorInfo
```

### æ•°æ®æµ

```
ç”¨æˆ·æ“ä½œ
    â”‚
    â–¼
ç»„ä»¶ (Component)
    â”‚
    â–¼
Hooks (useXxx)
    â”‚
    â–¼
Supabase Client
    â”‚
    â–¼
Supabase API
    â”‚
    â–¼
PostgreSQL / Storage / Edge Functions
    â”‚
    â–¼
è¿”å›æ•°æ®
    â”‚
    â–¼
æ›´æ–°çŠ¶æ€
    â”‚
    â–¼
é‡æ–°æ¸²æŸ“
```

## ğŸ—ï¸ åç«¯æ¶æ„

### Supabase æœåŠ¡

#### PostgreSQL æ•°æ®åº“

**ä¸»åº“ï¼ˆä¸ªäººç‚¹ä½ï¼‰**

è¡¨ï¼š`valorant_lineups`

```sql
CREATE TABLE valorant_lineups (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID REFERENCES auth.users(id),
  title TEXT NOT NULL,
  map_name TEXT NOT NULL,
  agent_name TEXT NOT NULL,
  agent_icon TEXT,
  side TEXT CHECK (side IN ('attack', 'defense')),
  ability_index INTEGER,
  stand_img TEXT,
  stand_desc TEXT,
  stand2_img TEXT,
  stand2_desc TEXT,
  aim_img TEXT,
  aim_desc TEXT,
  aim2_img TEXT,
  aim2_desc TEXT,
  land_img TEXT,
  land_desc TEXT,
  source_link TEXT,
  author_name TEXT,
  author_avatar TEXT,
  author_uid TEXT,
  cloned_from UUID,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

**å…±äº«åº“**

è¡¨ï¼š`valorant_shared`

```sql
CREATE TABLE valorant_shared (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  share_id TEXT UNIQUE NOT NULL,
  source_id UUID,
  user_id UUID,
  -- å…¶ä»–å­—æ®µä¸ valorant_lineups ç›¸åŒ
  created_at TIMESTAMP DEFAULT NOW(),
  expires_at TIMESTAMP DEFAULT NOW() + INTERVAL '15 days'
);
```

#### Row Level Security (RLS)

```sql
-- ä¸ªäººåº“ï¼šç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
CREATE POLICY "Users can view own lineups"
  ON valorant_lineups FOR SELECT
  USING (auth.uid() = user_id);

CREATE POLICY "Users can insert own lineups"
  ON valorant_lineups FOR INSERT
  WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update own lineups"
  ON valorant_lineups FOR UPDATE
  USING (auth.uid() = user_id);

CREATE POLICY "Users can delete own lineups"
  ON valorant_lineups FOR DELETE
  USING (auth.uid() = user_id);

-- å…±äº«åº“ï¼šæ‰€æœ‰äººå¯è¯»
CREATE POLICY "Anyone can view shared lineups"
  ON valorant_shared FOR SELECT
  USING (true);
```

#### Edge Functions

**get-video-author**

- è¿è¡Œæ—¶ï¼šDeno
- ç”¨é€”ï¼šè§£æ B ç«™å’ŒæŠ–éŸ³è§†é¢‘ä½œè€…ä¿¡æ¯
- ç«¯ç‚¹ï¼š`/functions/v1/get-video-author`
- æ–¹æ³•ï¼šPOST
- è¯·æ±‚ä½“ï¼š`{ "url": "è§†é¢‘é“¾æ¥" }`
- å“åº”ï¼š
  ```json
  {
    "status": "success",
    "data": {
      "username": "ä½œè€…æ˜µç§°",
      "avatar": "å¤´åƒ URL",
      "user_home_url": "ä¸»é¡µé“¾æ¥",
      "is_cover": false,
      "source": "bilibili" | "douyin"
    }
  }
  ```

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### ER å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   auth.users    â”‚
â”‚  (Supabase)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ 1
         â”‚
         â”‚ N
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   valorant_lineups          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  id (PK)                    â”‚
â”‚  user_id (FK)               â”‚
â”‚  title                      â”‚
â”‚  map_name                   â”‚
â”‚  agent_name                 â”‚
â”‚  side                       â”‚
â”‚  stand_img                  â”‚
â”‚  aim_img                    â”‚
â”‚  land_img                   â”‚
â”‚  source_link                â”‚
â”‚  author_name                â”‚
â”‚  author_avatar              â”‚
â”‚  cloned_from                â”‚
â”‚  created_at                 â”‚
â”‚  updated_at                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ 1
         â”‚
         â”‚ 1
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   valorant_shared           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  id (PK)                    â”‚
â”‚  share_id (UNIQUE)          â”‚
â”‚  source_id (FK)             â”‚
â”‚  user_id                    â”‚
â”‚  ... (åŒ lineups å­—æ®µ)      â”‚
â”‚  created_at                 â”‚
â”‚  expires_at                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç´¢å¼•è®¾è®¡

```sql
-- ä¸ªäººåº“ç´¢å¼•
CREATE INDEX idx_lineups_user_id ON valorant_lineups(user_id);
CREATE INDEX idx_lineups_map_name ON valorant_lineups(map_name);
CREATE INDEX idx_lineups_agent_name ON valorant_lineups(agent_name);
CREATE INDEX idx_lineups_created_at ON valorant_lineups(created_at DESC);

-- å…±äº«åº“ç´¢å¼•
CREATE INDEX idx_shared_share_id ON valorant_shared(share_id);
CREATE INDEX idx_shared_expires_at ON valorant_shared(expires_at);
```

## ç¬¬ä¸‰æ–¹é›†æˆ

### å›¾åºŠæœåŠ¡

#### é˜¿é‡Œäº‘ OSS

```typescript
import OSS from 'ali-oss';

const client = new OSS({
  accessKeyId: config.accessKeyId,
  accessKeySecret: config.accessKeySecret,
  bucket: config.bucket,
  region: config.area
});

await client.put(filename, file);
```

#### è…¾è®¯äº‘ COS

```typescript
import COS from 'cos-js-sdk-v5';

const cos = new COS({
  SecretId: config.secretId,
  SecretKey: config.secretKey
});

await cos.putObject({
  Bucket: `${config.bucket}-${config.appId}`,
  Region: config.area,
  Key: filename,
  Body: file
});
```

#### ä¸ƒç‰›äº‘ Kodo

```typescript
import * as qiniu from 'qiniu-js';

const token = getUploadToken(config);

await qiniu.upload(file, filename, token, {
  region: config.area
});
```

### å¤–éƒ¨ API

#### Valorant API

```typescript
// è·å–è‹±é›„æ•°æ®
const response = await fetch(
  'https://valorant-api.com/v1/agents?language=zh-CN&isPlayableCharacter=true'
);
const data = await response.json();
```

#### B ç«™ API

é€šè¿‡ Edge Function è°ƒç”¨ï¼š
```
https://api.bilibili.com/x/web-interface/view?bvid={bvid}
```

#### æŠ–éŸ³ API

é€šè¿‡ Edge Function è°ƒç”¨ï¼Œä½¿ç”¨ HTML è§£æã€‚

## âš¡ æ€§èƒ½ä¼˜åŒ–

### å‰ç«¯ä¼˜åŒ–

1. **ä»£ç åˆ†å‰²**
   - `Vite` è‡ªåŠ¨è¿›è¡Œè·¯ç”±çº§åˆ«çš„ä»£ç åˆ†å‰²
   - åŠ¨æ€å¯¼å…¥å¤§å‹ç»„ä»¶

2. **å›¾ç‰‡ä¼˜åŒ–**
   - ä¸Šä¼ æ—¶è‡ªåŠ¨å‹ç¼©
   - ä½¿ç”¨ `WebP` ã€`PNG` æ ¼å¼
   - æ‡’åŠ è½½

3. **ç¼“å­˜ç­–ç•¥**
   - `LocalStorage` ç¼“å­˜é…ç½®
   - `React Query` ç¼“å­˜æ•°æ®
   - `Service Worker`ï¼ˆå¯é€‰ï¼‰

4. **æ¸²æŸ“ä¼˜åŒ–**
   - `React.memo` é¿å…ä¸å¿…è¦çš„æ¸²æŸ“
   - `useMemo / useCallback` ä¼˜åŒ–è®¡ç®—
   - è™šæ‹Ÿæ»šåŠ¨ï¼ˆå¤§åˆ—è¡¨ï¼‰

### åç«¯ä¼˜åŒ–

1. **æ•°æ®åº“ä¼˜åŒ–**
   - åˆç†çš„ç´¢å¼•è®¾è®¡
   - æŸ¥è¯¢ä¼˜åŒ–ï¼ˆé¿å… N+1ï¼‰
   - è¿æ¥æ± ç®¡ç†

2. **CDN åŠ é€Ÿ**
   - é™æ€èµ„æº `CDN`
   - å›¾ç‰‡ `CDN`
   - `API CDN`ï¼ˆCloudflareï¼‰

3. **ç¼“å­˜ç­–ç•¥**
   - `Supabase` è‡ªåŠ¨ç¼“å­˜
   - `Edge Function` ç¼“å­˜
   - æµè§ˆå™¨ç¼“å­˜

## ğŸ”’ å®‰å…¨è®¾è®¡

### å‰ç«¯å®‰å…¨

1. **XSS é˜²æŠ¤**
   - `React` è‡ªåŠ¨è½¬ä¹‰
   - é¿å… `dangerouslySetInnerHTML`

2. **CSRF é˜²æŠ¤**
   - `Supabase JWT Token`
   - `SameSite Cookie`

3. **æ•æ„Ÿä¿¡æ¯**
   - ç¯å¢ƒå˜é‡ç®¡ç†
   - ä¸åœ¨å‰ç«¯å­˜å‚¨å¯†é’¥

### åç«¯å®‰å…¨

1. **RLS æƒé™æ§åˆ¶**
   - ç”¨æˆ·åªèƒ½è®¿é—®è‡ªå·±çš„æ•°æ®
   - å…±äº«åº“å…¬å¼€è®¿é—®

2. **API é™æµ**
   - `Supabase` è‡ªåŠ¨é™æµ
   - `Edge Function` é™æµ

3. **æ•°æ®éªŒè¯**
   - å‰ç«¯éªŒè¯
   - åç«¯éªŒè¯ `ï¼ˆRLS + Triggersï¼‰`

## ğŸ“ˆ ç›‘æ§å’Œæ—¥å¿—

### å‰ç«¯ç›‘æ§

- é”™è¯¯ç›‘æ§ï¼š `Sentry`
- æ€§èƒ½ç›‘æ§ï¼š `Web Vitals`
- ç”¨æˆ·è¡Œä¸ºï¼š `Google Analytics`

### åç«¯ç›‘æ§

- `Supabase Dashboard`
- æ•°æ®åº“æ€§èƒ½ç›‘æ§
- `Edge Function` æ—¥å¿—

## æ‰©å±•æ€§è®¾è®¡

### æ°´å¹³æ‰©å±•

- `Supabase` è‡ªåŠ¨æ‰©å±•
- `CDN` å…¨çƒåˆ†å¸ƒ
- æ— çŠ¶æ€è®¾è®¡

### åŠŸèƒ½æ‰©å±•

- æ’ä»¶åŒ–æ¶æ„
- æ¨¡å—åŒ–è®¾è®¡
- é…ç½®åŒ–ç®¡ç†

## ğŸ—ï¸ æŠ€æœ¯é€‰å‹ç†ç”±

| æŠ€æœ¯           | ç†ç”±           |
| ------------ | ------------ |
| React        | ç”Ÿæ€æˆç†Ÿï¼Œç»„ä»¶åŒ–å¼€å‘   |
| TypeScript   | ç±»å‹å®‰å…¨ï¼Œå‡å°‘ Bug  |
| Vite         | å¿«é€Ÿæ„å»ºï¼ŒHMR ä½“éªŒå¥½ |
| Supabase     | å¼€ç®±å³ç”¨ï¼Œé™ä½åç«¯æˆæœ¬  |
| Tailwind CSS | å¿«é€Ÿå¼€å‘ï¼Œæ ·å¼ä¸€è‡´    |
| Leaflet      | è½»é‡çº§åœ°å›¾åº“ï¼Œè‡ªå®šä¹‰æ€§å¼º |
<!-- 
 ## æœªæ¥è§„åˆ’

- [ ] ç§»åŠ¨ç«¯ Appï¼ˆReact Nativeï¼‰
- [ ] å®æ—¶åä½œåŠŸèƒ½ï¼ˆSupabase Realtimeï¼‰
- [ ] AI æ¨èç‚¹ä½
- [ ] è§†é¢‘ä¸Šä¼ å’Œæ’­æ”¾
- [ ] ç¤¾åŒºåŠŸèƒ½ï¼ˆè¯„è®ºã€ç‚¹èµï¼‰
- [ ] æ•°æ®åˆ†æå’Œç»Ÿè®¡
-->
