# æ•°æ®åº“å»ºè¡¨
## SupaBase - Table Editor
ä»¥ä¸‹æ‰€æœ‰ä»£ç ï¼Œéƒ½åœ¨ `SupaBase` çš„ `SQL Editor` å¤„æ‰§è¡Œï¼Œä¸‹æ–¹ç‚¹å‡» `details Click me to view the code` æŸ¥çœ‹ä»£ç ã€‚

<figure class="full-bleed">
  <img class="full-bleed" src="../public/SQL-Editor.png" alt="supabaseç¼–è¾‘é¡µ" />
  <figcaption>supabaseç¼–è¾‘é¡µ</figcaption>
</figure>

### ä¸€ç‚¹å»ºè®®

å»ºè®®æ–°å¢ä¸¤ä¸ªé¡¹ç›®ï¼Œä¸€ä¸ªå­˜æ”¾ç‚¹ä½ã€ç”¨æˆ·ã€ç™½åå•ï¼Œå¦‚ï¼š `Demo_val` ï¼›å¦ä¸€ä¸ªé¡¹ç›®å­˜æ”¾åˆ†äº«åº“çš„ç‚¹ä½ï¼Œå¦‚ï¼š `Demo_share` ï¼›å› ä¸ºåˆ†äº«åº“çš„ `KEY` æ˜¯è¦åˆ†äº«å‡ºå»ï¼Œå¤§å®¶æ‰èƒ½åˆ°ä½ è¿™é‡Œåˆ†äº«åˆ†äº«ç‚¹ä½ï¼Œæ‰€ä»¥å°±ä¼šå­˜åœ¨æ³„æ¼ `KEY` çš„é£é™©ï¼Œå¦‚æœå°†å®ƒç‹¬ç«‹èµ·æ¥ï¼Œå°±ä¸ç”¨æ€•å­˜åœ¨ä»€ä¹ˆæ•°æ®é—®é¢˜äº†ï¼Œå½“ç„¶ï¼Œå¦‚æœä½ æ˜¯è‡ªå·±ä½¿ç”¨ï¼Œé‚£å°±æ— æ‰€è°“äº†ã€‚


<figure class="full-bleed">
  <img class="full-bleed" src="../public/æ•°æ®åº“ä¸»é¡µ.png" alt="æ•°æ®åº“ä¸»é¡µ" />
  <figcaption>å…è´¹ç‰ˆåªèƒ½æ–°å»ºä¸¤ä¸ªé¡¹ç›®</figcaption>
</figure>

## ğŸ“Š æ ¸å¿ƒä¸šåŠ¡è¡¨

> [!TIP]
> ä»£ç è¯´æ˜ï¼š **valorant_lineups** æ•°æ®è¡¨å­˜æ”¾çš„æ˜¯ç‚¹ä½æ•°æ®ï¼Œ **valorant_users** æ•°æ®è¡¨å­˜æ”¾çš„æ˜¯ç”¨æˆ·IDæ•°æ®ã€‚
>
> å¦‚æœä½ å¸Œæœ›ä½ è‡ªå·±çš„æ•°æ®æŒä¹…åŒ–ï¼Œé‚£ä¹ˆä¸€å®šè¦æ–°å¢è‡ªå·±çš„æ•°æ®è¡¨ï¼Œ<b>å› ä¸ºæˆ‘ä¸èƒ½ä¿è¯æˆ‘çš„æ¼”ç¤ºç½‘ç«™èƒ½è¿è¡Œå¤šä¹…ï¼Œè€Œä¸”æˆ‘çš„å…±äº«åº“è®¾ç½®äº†å®šæ—¶æ¸…ç†ä»»åŠ¡ï¼Œè¶…è¿‡15å¤©çš„åˆ†äº«ç‚¹ä½ï¼Œå°†ä¼šè¢«æ¸…ç†</b>ï¼Œæ‰€ä»¥å¦‚æœåœ¨å…±äº«åº“é‡åˆ°è‡ªå·±å–œæ¬¢çš„ç‚¹ä½ï¼Œè¯·å°½å¿«ä¿å­˜åˆ°è‡ªå·±çš„ä¸ªäººåº“ä¸­ã€‚

::: details Click me to view the code

``` sql
-- 0) åŸºç¡€æ‰©å±• (å¿…é¡»ï¼Œç”¨äº gen_random_uuid)
create extension if not exists pgcrypto;

--------------------------------------------------------------------------------
-- 1) æ ¸å¿ƒè¡¨ç»“æ„
--------------------------------------------------------------------------------

-- Table: valorant_lineups
create table if not exists public.valorant_lineups (
  id              uuid primary key default gen_random_uuid(),
  user_id         text not null,
  title           text not null,
  map_name        text not null,
  agent_name      text not null,
  agent_icon      text,
  skill_icon      text,
  side            text not null default 'attack', -- attack / defense
  ability_index   int,
  agent_pos       jsonb,
  skill_pos       jsonb,
  stand_img       text,
  stand_desc      text,
  stand2_img      text,
  stand2_desc     text,
  aim_img         text,
  aim_desc        text,
  aim2_img        text,
  aim2_desc       text,
  land_img        text,
  land_desc       text,
  source_link     text,
  cloned_from     text,
  -- ä½œè€…ä¿¡æ¯å­—æ®µ
  author_name     text,
  author_avatar   text,
  author_uid      text,
  -- æ—¶é—´æˆ³
  created_at      timestamptz not null default now(),
  updated_at      timestamptz not null default now()
);

-- Table: valorant_users
create table if not exists public.valorant_users (
  user_id    text primary key,
  password   text,
  created_at timestamptz not null default now(),
  updated_at timestamptz not null default now()
);

--------------------------------------------------------------------------------
-- 2) ç´¢å¼•
--------------------------------------------------------------------------------
create index if not exists idx_lineups_user_created_at 
  on public.valorant_lineups (user_id, created_at desc);

--------------------------------------------------------------------------------
-- 3) RLS ç­–ç•¥
--------------------------------------------------------------------------------

-- lineups
alter table if exists public.valorant_lineups enable row level security;

create policy "anon select lineups" 
  on public.valorant_lineups for select using (auth.role() = 'anon');

create policy "anon insert lineups" 
  on public.valorant_lineups for insert with check (auth.role() = 'anon');

create policy "anon update lineups" 
  on public.valorant_lineups for update using (auth.role() = 'anon');

create policy "anon delete lineups" 
  on public.valorant_lineups for delete using (auth.role() = 'anon');

-- users
alter table if exists public.valorant_users enable row level security;

create policy "anon select users" 
  on public.valorant_users for select using (auth.role() = 'anon');

create policy "anon upsert users" 
  on public.valorant_users for insert with check (auth.role() = 'anon');

create policy "anon update users" 
  on public.valorant_users for update using (auth.role() = 'anon');
```
:::

## ğŸ§© å…±äº«åŠŸèƒ½è¡¨

å»ºè®®å¦èµ·ä¸€ä¸ªé¡¹ç›®å­˜æ”¾è¯¥è¡¨ï¼Œè¯¦è§[ä¸€ç‚¹å»ºè®®](#ä¸€ç‚¹å»ºè®®)

> [!TIP]
> ä»£ç è¯´æ˜ï¼š **valorant_shared** æ•°æ®è¡¨å­˜æ”¾çš„æ˜¯å…±äº«åº“æ•°æ®
>
> å¦‚æœè‡ªå·±ä¸æƒ³æ­å»ºå…±äº«åº“ï¼Œå¯ä»¥ä¸ç”¨çœ‹è¿™ä¸€æ­¥

::: details Click me to view the code

``` sql
-- 0) åŸºç¡€æ‰©å±• (é˜²æ­¢å•ç‹¬æ‰§è¡Œæ­¤æ–‡ä»¶æ—¶æŠ¥é”™)
create extension if not exists pgcrypto;

--------------------------------------------------------------------------------
-- 1) å…±äº«è¡¨ç»“æ„
--------------------------------------------------------------------------------

-- Table: valorant_shared
create table if not exists public.valorant_shared (
  share_id        text primary key,
  source_id       uuid, -- é€»è¾‘ä¸Šå…³è” lineups.idï¼Œä½†æ­¤å¤„åšè½¯å…³è”
  id              uuid default gen_random_uuid(),
  user_id         text,
  title           text not null,
  map_name        text not null,
  agent_name      text not null,
  agent_icon      text,
  skill_icon      text,
  side            text not null default 'attack',
  ability_index   int,
  agent_pos       jsonb,
  skill_pos       jsonb,
  stand_img       text,
  stand_desc      text,
  stand2_img      text,
  stand2_desc     text,
  aim_img         text,
  aim_desc        text,
  aim2_img        text,
  aim2_desc       text,
  land_img        text,
  land_desc       text,
  source_link     text,
  cloned_from     text,
  created_at      timestamptz not null default now(),
  updated_at      timestamptz not null default now()
);

--------------------------------------------------------------------------------
-- 2) ç´¢å¼•
--------------------------------------------------------------------------------
create index if not exists idx_shared_source 
  on public.valorant_shared (source_id);

--------------------------------------------------------------------------------
-- 3) RLS ç­–ç•¥
--------------------------------------------------------------------------------

alter table if exists public.valorant_shared enable row level security;

create policy "anon select shared" 
  on public.valorant_shared for select using (auth.role() = 'anon');

create policy "anon insert shared" 
  on public.valorant_shared for insert with check (auth.role() = 'anon');

create policy "anon update shared" 
  on public.valorant_shared for update using (auth.role() = 'anon');

create policy "anon delete shared" 
  on public.valorant_shared for delete using (auth.role() = 'anon');
```
:::

### å®šæ—¶æ¸…ç†ä»»åŠ¡

è¿™ä¸ªè¡¨ï¼Œæ˜¯è¦åœ¨ ` valorant_shared` æ‰€åœ¨çš„é¡¹ç›®æ“ä½œçš„ã€‚

> [!TIP]
> åŒç†ï¼Œå¦‚æœä½ æ²¡æœ‰æ­å»ºå…±äº«åº“ï¼Œé‚£ä¹ˆä¹Ÿæ— éœ€è®¾ç½®å®šæ—¶ä»»åŠ¡

::: details Click me to view the code

``` sql
-- 0) å¼€å¯å®šæ—¶ä»»åŠ¡æ‰©å±• (å¿…é¡»å®‰è£… pg_cron)
create extension if not exists pg_cron with schema extensions;

--------------------------------------------------------------------------------
-- 1) ç™½åå•è¡¨ (æ”¹ä¸ºå­˜å‚¨ user_id)
--------------------------------------------------------------------------------
create table if not exists public.valorant_whitelist (
  user_id     text primary key,      -- æ ¸å¿ƒå˜åŠ¨ï¼šè¿™é‡Œå­˜çš„æ˜¯ user_id
  note        text,                  -- å¤‡æ³¨ï¼Œä¾‹å¦‚ï¼š"ç®¡ç†å‘˜"ã€"VIPç”¨æˆ·"
  created_at  timestamptz default now()
);

-- (å¯é€‰) å¼€å¯ RLS
alter table public.valorant_whitelist enable row level security;

--------------------------------------------------------------------------------
-- 2) æ¸…ç†å‡½æ•°
--------------------------------------------------------------------------------
create or replace function public.cleanup_expired_shares()
returns void
language plpgsql
security definer
set search_path = public
as $$
begin
  -- åˆ é™¤é€»è¾‘ï¼š
  -- 1. åˆ›å»ºæ—¶é—´æ—©äº 15 å¤©å‰
  -- 2. ä¸” (è¯¥è®°å½•çš„ user_id ä¸åœ¨ç™½åå•è¡¨ä¸­ OR user_id ä¸ºç©º)
  
  delete from public.valorant_shared s
  where s.created_at < now() - interval '15 days'
  and not exists (
      select 1 
      from public.valorant_whitelist w 
      where w.user_id = s.user_id
  );
  
  -- è§£é‡Šï¼š
  -- å¦‚æœ s.user_id åœ¨ç™½åå•é‡Œï¼ŒEXISTS ä¸ºçœŸï¼ŒNOT EXISTS ä¸ºå‡ -> ä¸åˆ é™¤ (ä¿ç•™)
  -- å¦‚æœ s.user_id ä¸åœ¨ç™½åå•é‡Œï¼ŒEXISTS ä¸ºå‡ï¼ŒNOT EXISTS ä¸ºçœŸ -> åˆ é™¤
  -- å¦‚æœ s.user_id ä¸º NULL (åŒ¿ååˆ†äº«)ï¼ŒNULL = w.user_id æ°¸è¿œä¸æˆç«‹ï¼ŒEXISTS ä¸ºå‡ï¼ŒNOT EXISTS ä¸ºçœŸ -> åˆ é™¤
end;
$$;

--------------------------------------------------------------------------------
-- 3) æ³¨å†Œå®šæ—¶ä»»åŠ¡ (æ¯å¤©å‡Œæ™¨ 03:00 æ‰§è¡Œ)
--------------------------------------------------------------------------------

-- å…ˆå°è¯•ç§»é™¤åŒåä»»åŠ¡ï¼ˆå­˜åœ¨æ‰åˆ ï¼Œé¿å…æŠ¥é”™ï¼‰
DO $$
DECLARE jid int;
BEGIN
  SELECT jobid INTO jid
  FROM cron.job
  WHERE jobname = 'valorant-cleanup-daily';

  IF jid IS NOT NULL THEN
    PERFORM cron.unschedule(jid);
  END IF;
END $$;

-- åˆ›å»ºæ–°ä»»åŠ¡
select cron.schedule(
  'valorant-cleanup-daily',   
  '0 3 * * *',                
  'select public.cleanup_expired_shares()'
);
```
:::

### æŸ¥çœ‹å®šæ—¶ä»»åŠ¡
``` sql
select * from cron.job;
```

### åˆ é™¤å®šæ—¶ä»»åŠ¡

`SELECT cron.unschedule(1);` ä¸­çš„ `1` æ˜¯ `jobid` ï¼Œè¿è¡ŒæŸ¥çœ‹å®šæ—¶ä»»åŠ¡ï¼Œå¯ä»¥çœ‹å¾—åˆ°ã€‚

``` sql
-- 1. å…ˆç¡®è®¤è¿™ä¸ªä»»åŠ¡æ˜¯å¦å­˜åœ¨
SELECT jobid, jobname
FROM cron.job
WHERE jobname = 'valorant-cleanup-daily';
-- 2. åˆ é™¤å®šæ—¶ä»»åŠ¡
SELECT cron.unschedule(1);

```

### ç«‹å³æ‰§è¡Œä¸€æ¬¡æ¸…ç†ä»»åŠ¡
``` sql
select public.cleanup_expired_shares();
```

### å®šæ—¶ä»»åŠ¡æ·»åŠ ç™½åå•

``` sql
insert into public.valorant_whitelist (user_id, note)
values ('user_12345_abcde', 'ç‰¹æƒç”¨æˆ·ï¼Œæ°¸ä¹…ä¿ç•™æ•°æ®')
on conflict (user_id) do nothing;
```

å…¶ä¸­ `user_12345_abcde` æ¢æˆä½ è‡ªå·±çš„ID

## SupaBase - Edge Functions
åœ¨ä½ å­˜æ”¾ **ç‚¹ä½è¡¨** çš„é¡¹ç›®ä¸­æ–°å¢ï¼Œå¦‚ï¼š `Demo_val`  ï¼Œç‚¹å‡» `Deploy a new function` æ–°å¢ï¼Œå¹¶åœ¨ä¸‹é¢å¡«å…¥ `get-video-author` æ ‡é¢˜

> [!TIP]
> ä»£ç è¯´æ˜ï¼š **get-video-author** æ˜¯ç”¨æ¥è·å–ç‚¹ä½è§†é¢‘åšä¸»çš„å¤´åƒ+ç”¨æˆ·åä¿¡æ¯

::: details Click me to view the code

``` sql
import { serve } from "https://deno.land/std@0.168.0/http/server.ts"

  

const corsHeaders = {

Â  'Access-Control-Allow-Origin': '*',

Â  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',

}

  

// === æŠ–éŸ³ä¸“ç”¨æ¸…æ´—å‡½æ•° ===

function cleanHtml(text: string) {

Â  let decoded = text

Â  Â  .replace(/\\u002F/g, "/")

Â  Â  .replace(/\\u0026/g, "&")

Â  Â  .replace(/\\"/g, '"')

Â  Â  .replace(/&quot;/g, '"')

Â  Â  .replace(/&amp;/g, '&')

Â  Â  .replace(/\\\//g, '/');

Â  try { decoded = decodeURIComponent(decoded); } catch (e) {}

Â  return decoded;

}

  

// === Bilibili è§£ææ ¸å¿ƒ (API æ¨¡å¼) ===

async function handleBilibili(targetUrl: string) {

Â  Â  console.log("æ­£åœ¨è§£æ Bilibili:", targetUrl)

  

Â  Â  // 1. æå– BV å·

Â  Â  // Bç«™è§†é¢‘ ID é€šå¸¸æ˜¯ BV å¼€å¤´çš„ 10-12 ä½å­—ç¬¦

Â  Â  const bvMatch = targetUrl.match(/(BV[a-zA-Z0-9]+)/)

Â  Â  if (!bvMatch) {

Â  Â  Â  Â  throw new Error("æœªæ‰¾åˆ°æœ‰æ•ˆçš„ BV å·")

Â  Â  }

Â  Â  const bvid = bvMatch[1]

Â  Â  console.log("æå–åˆ° BVID:", bvid)

  

Â  Â  // 2. ç›´æ¥è°ƒç”¨ B ç«™å®˜æ–¹ API

Â  Â  // è¿™æ˜¯ä¸€ä¸ªå…¬å¼€æ¥å£ï¼Œé€šå¸¸ä¸éœ€è¦å¤æ‚çš„ Cookie å°±èƒ½è®¿é—®

Â  Â  const apiUrl = `https://api.bilibili.com/x/web-interface/view?bvid=${bvid}`

Â  Â  // å³ä½¿æ˜¯ APIï¼Œä¹Ÿéœ€è¦ä¼ªè£…ä¸€ä¸‹ UA

Â  Â  const headers = {

Â  Â  Â  Â  "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36",

Â  Â  Â  Â  "Referer": "https://www.bilibili.com/"

Â  Â  }

  

Â  Â  const response = await fetch(apiUrl, { headers })

Â  Â  const json = await response.json()

  

Â  Â  // 3. è§£æ API è¿”å›çš„ JSON

Â  Â  // æˆåŠŸä»£ç æ˜¯ 0

Â  Â  if (json.code === 0 && json.data) {

Â  Â  Â  Â  const data = json.data

Â  Â  Â  Â  const owner = data.owner

Â  Â  Â  Â  return {

Â  Â  Â  Â  Â  Â  username: owner.name,

Â  Â  Â  Â  Â  Â  avatar: owner.face, // Bç«™ API è¿”å›çš„å¤´åƒé€šå¸¸æ˜¯ http æˆ– https

Â  Â  Â  Â  Â  Â  user_home_url: `https://space.bilibili.com/${owner.mid}`,

Â  Â  Â  Â  Â  Â  is_cover: false,

Â  Â  Â  Â  Â  Â  source: "bilibili",

Â  Â  Â  Â  Â  Â  // é¢å¤–ç¦åˆ©ï¼šBç«™å°é¢å›¾

Â  Â  Â  Â  Â  Â  cover_image: data.pic

Â  Â  Â  Â  }

Â  Â  } else {

Â  Â  Â  Â  throw new Error(`Bç«™ API æŠ¥é”™: code=${json.code}, message=${json.message}`)

Â  Â  }

}

  

// === æŠ–éŸ³ è§£ææ ¸å¿ƒ (ä¿æŒ V17 æœ€ç¨³ç‰ˆæœ¬) ===

async function handleDouyin(targetUrl: string) {

Â  Â  console.log("æ­£åœ¨è§£æ æŠ–éŸ³:", targetUrl)

Â  Â  const headers = {

Â  Â  Â  Â  "User-Agent": "Mozilla/5.0 (iPad; CPU OS 13_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) CriOS/87.0.4280.77 Mobile/15E148 Safari/604.1",

Â  Â  Â  Â  "Referer": "https://www.douyin.com/"

Â  Â  }

  

Â  Â  const response = await fetch(targetUrl, { headers })

Â  Â  const rawHtml = await response.text()

Â  Â  const html = cleanHtml(rawHtml)

  

Â  Â  let nickname = "", avatar = "", sec_uid = ""

  

Â  Â  // 1. æå–ä¸»é¡µ (iPad href ç­–ç•¥)

Â  Â  const linkRegex = /href=["']\/\/www\.douyin\.com\/user\/(MS4wLjABAAAA[A-Za-z0-9_\\-]+)["']/

Â  Â  const linkMatch = html.match(linkRegex)

Â  Â  if (linkMatch) sec_uid = linkMatch[1]

Â  Â  if (!sec_uid) {

Â  Â  Â  Â  const routeMatch = html.match(/\/user\/(MS4wLjABAAAA[A-Za-z0-9_\\-]+)/)

Â  Â  Â  Â  if (routeMatch) sec_uid = routeMatch[1]

Â  Â  }

Â  Â  if (!sec_uid) {

Â  Â  Â  Â  const authorBlock = html.match(/"author"\s*:\s*\{[\s\S]*?"sec_uid"\s*:\s*"(MS4wLjABAAAA[A-Za-z0-9_\\-]+)"/)

Â  Â  Â  Â  if (authorBlock) sec_uid = authorBlock[1]

Â  Â  }

  

Â  Â  const userHomeUrl = sec_uid ? `https://www.douyin.com/user/${sec_uid}` : ""

  

Â  Â  // 2. æå–å¤´åƒ

Â  Â  const avatarMatch = html.match(/"url_list":\["(https:\/\/[^"]*?aweme-avatar[^"]*?)"/)

Â  Â  if (avatarMatch) avatar = avatarMatch[1]

  

Â  Â  if (!avatar) {

Â  Â  Â  Â  const jsonMatch = html.match(/"avatar_(larger|medium|thumb)":\{"uri":"[^"]*","url_list":\["(https:\/\/[^"]+)"/)

Â  Â  Â  Â  if (jsonMatch) avatar = jsonMatch[2]

Â  Â  }

Â  Â  if (!avatar) {

Â  Â  Â  Â  const manualMatch = html.match(/(https:\/\/[^"']*?100x100\/aweme-avatar[^"']*)/)

Â  Â  Â  Â  if (manualMatch) avatar = manualMatch[1]

Â  Â  }

  

Â  Â  let isCover = false

Â  Â  if (!avatar) {

Â  Â  Â  Â  const coverMatch = html.match(/<img[^>]+src=["'](https:\/\/[^"']+)["']/)

Â  Â  Â  Â  if (coverMatch) {

Â  Â  Â  Â  Â  Â  avatar = coverMatch[1]; isCover = true

Â  Â  Â  Â  }

Â  Â  }

  

Â  Â  // 3. æå–ç”¨æˆ·å

Â  Â  if (avatar && !isCover) {

Â  Â  Â  Â  const urlPart = avatar.split('?')[0].split('/').pop();

Â  Â  Â  Â  if (urlPart && urlPart.length > 5) {

Â  Â  Â  Â  Â  Â  Â const altRegex = new RegExp(`<img[^>]*${urlPart}[^>]*alt=["']([^"']+)["']`)

Â  Â  Â  Â  Â  Â  Â const altMatch = html.match(altRegex)

Â  Â  Â  Â  Â  Â  Â if (altMatch) nickname = altMatch[1]

Â  Â  Â  Â  }

Â  Â  }

Â  Â  if (!nickname) {

Â  Â  Â  Â  const titleMatch = html.match(/<title>(.*?)[\s-]*æŠ–éŸ³/)

Â  Â  Â  Â  if (titleMatch) nickname = titleMatch[1].trim()

Â  Â  }

Â  Â  if (!nickname) {

Â  Â  Â  Â  const jsonName = html.match(/"nickname"\s*:\s*"([^"]+)"/)

Â  Â  Â  Â  if (jsonName) nickname = jsonName[1]

Â  Â  }

  

Â  Â  return {

Â  Â  Â  Â  username: nickname || "æœªæå–åˆ°",

Â  Â  Â  Â  avatar: avatar || "",

Â  Â  Â  Â  user_home_url: userHomeUrl,

Â  Â  Â  Â  is_cover: isCover,

Â  Â  Â  Â  source: "douyin"

Â  Â  }

}

  

// === ä¸»å…¥å£ ===

serve(async (req) => {

Â  if (req.method === 'OPTIONS') return new Response('ok', { headers: corsHeaders })

  

Â  try {

Â  Â  const body = await req.json()

Â  Â  const urlText = body.url || ""

Â  Â  console.log("æ”¶åˆ°è¯·æ±‚å†…å®¹:", urlText.substring(0, 100))

  

Â  Â  if (!urlText) throw new Error("ç¼ºå°‘ URL å‚æ•°")

  

Â  Â  // 1. æŠ–éŸ³æ­£åˆ™ (åŒ…å« v.douyin å’Œ www.douyin)

Â  Â  // [^\s"']+ å…è®¸ç‰¹æ®Šå­—ç¬¦é“¾æ¥

Â  Â  const douyinRegex = /(https?:\/\/(?:v|www|www\.iesdouyin|m)\.douyin\.com\/[^\s"']+)/

Â  Â  // 2. Bç«™æ­£åˆ™ (åŒ…å« b23.tv å’Œ bilibili.com)

Â  Â  const biliRegex = /(https?:\/\/(?:www|m)\.bilibili\.com\/video\/[^\s"']+)|(https?:\/\/b23\.tv\/[^\s"']+)/

  

Â  Â  let targetUrl = ""

Â  Â  let platform = ""

  

Â  Â  const matchDouyin = urlText.match(douyinRegex)

Â  Â  const matchBili = urlText.match(biliRegex)

  

Â  Â  if (matchDouyin) {

Â  Â  Â  Â  targetUrl = matchDouyin[0]

Â  Â  Â  Â  platform = "douyin"

Â  Â  } else if (matchBili) {

Â  Â  Â  Â  targetUrl = matchBili[0]

Â  Â  Â  Â  platform = "bilibili"

Â  Â  } else {

Â  Â  Â  Â  throw new Error("æ— æ•ˆé“¾æ¥ï¼šæœªè¯†åˆ«åˆ° æŠ–éŸ³ æˆ– Bç«™ é“¾æ¥")

Â  Â  }

  

Â  Â  let result;

Â  Â  if (platform === "douyin") {

Â  Â  Â  Â  result = await handleDouyin(targetUrl)

Â  Â  } else if (platform === "bilibili") {

Â  Â  Â  Â  let finalUrl = targetUrl

Â  Â  Â  Â  // å¤„ç† b23.tv çŸ­é“¾é‡å®šå‘

Â  Â  Â  Â  if (targetUrl.includes("b23.tv")) {

Â  Â  Â  Â  Â  Â  Â console.log("è§£æ Bç«™çŸ­é“¾...")

Â  Â  Â  Â  Â  Â  Â const r = await fetch(targetUrl, { redirect: 'follow' })

Â  Â  Â  Â  Â  Â  Â finalUrl = r.url

Â  Â  Â  Â  Â  Â  Â console.log("è¿˜åŸé•¿é“¾:", finalUrl)

Â  Â  Â  Â  }

Â  Â  Â  Â  result = await handleBilibili(finalUrl)

Â  Â  }

  

Â  Â  return new Response(

Â  Â  Â  JSON.stringify({ status: "success", data: result }),

Â  Â  Â  { headers: { ...corsHeaders, "Content-Type": "application/json" } }

Â  Â  )

  

Â  } catch (error) {

Â  Â  console.error("å¤„ç†å‡ºé”™:", error.message)

Â  Â  return new Response(JSON.stringify({ error: error.message }), { headers: { ...corsHeaders, "Content-Type": "application/json" }, status: 400 })

Â  }

})
```

:::

<figure class="full-bleed">
  <img class="full-bleed" src="../public/Edge-Functions-01.png" alt="Edge-Functions-01" />
  <figcaption>æ­¥éª¤1</figcaption>
</figure>


<figure class="full-bleed">
  <img class="full-bleed" src="../public/Edge-Functions-02.png" alt="Edge-Functions-02" />
  <figcaption>æ­¥éª¤2</figcaption>
</figure>

<figure class="full-bleed">
  <img class="full-bleed" src="../public/Edge-Functions-03.png" alt="Edge-Functions-03" />
  <figcaption>æ­¥éª¤3</figcaption>
</figure>

<figure class="full-bleed">
  <img class="full-bleed" src="../public/Edge-Functions-04.png" alt="Edge-Functions-04" />
  <figcaption>æ­¥éª¤4</figcaption>
</figure>

---

å¦‚æœèƒ½å¾—åˆ°ä»¥ä¸‹çš„è¿”å›ç»“æœï¼Œå°±è¯´æ˜è°ƒè¯•æˆåŠŸäº†
### Bç«™æµ‹è¯•æ•°æ®

``` json
{ "url": "ã€è¿™å‡ å¹´ï¼Œç”µè§†ç”»è´¨ä¸ºä»€ä¹ˆå˜å·®äº†...ã€‘ ã€ç²¾å‡†ç©ºé™åˆ° 02:26ã€‘ https://www.bilibili.com/video/BV1acmCBtEst/?share_source=copy_web&vd_source=fd59995bf2f70580369462145819da94&t=146" }
```

#### è¿”å›ç»“æœ

``` json
{
  "status": "success",
  "data": {
    "username": "å½±è§†é£“é£",
    "avatar": "https://i0.hdslb.com/bfs/face/c1733474892caa45952b2c09a89323157df7129a.jpg",
    "user_home_url": "https://space.bilibili.com/946974",
    "is_cover": false,
    "source": "bilibili",
    "cover_image": "http://i2.hdslb.com/bfs/archive/2ca10436a2d9343d6b03739dd9914edfef021a07.jpg"
  }
}
```

### æŠ–éŸ³æµ‹è¯•æ•°æ®

``` json
{ "url": "0.20 c@N.Ji 03/08 seb:/ è¿™å‡ å¹´ï¼Œç”µè§†ç”»è´¨ä¸ºä»€ä¹ˆå˜å·®äº†...# ç”µè§† # ç”»è´¨ # ç”µè§†è®¾ç½® # æŠ€æœ¯ # ä½“éªŒ  https://v.douyin.com/3HrmbOLNjZw/ å¤åˆ¶æ­¤é“¾æ¥ï¼Œæ‰“å¼€DouéŸ³æœç´¢ï¼Œç›´æ¥è§‚çœ‹è§†é¢‘ï¼" }
```

#### è¿”å›ç»“æœ

``` json
{
  "status": "success",
  "data": {
    "username": "å½±è§†é£“é£",
    "avatar": "https://p3.douyinpic.com/aweme/100x100/aweme-avatar/tos-cn-avt-0015_a8cf976fa76120a291a9aacb9c4439f8.jpeg?from=327834062",
    "user_home_url": "https://www.douyin.com/user/MS4wLjABAAAAaCcBHb3Rhc4zxF8YkBOfHfLh6k-IWEK2l3Ne9xOXPnQ",
    "is_cover": false,
    "source": "douyin"
  }
}
```






## æœŸæœ›ç»“æœ

<figure class="full-bleed">
  <img class="full-bleed" src="../public/Demo_val.png" alt="Demo_val" />
  <figcaption>Demo_valåº“å­˜åœ¨çš„ä¸¤å¼ è¡¨</figcaption>
</figure>


<figure class="full-bleed">
  <img class="full-bleed" src="../public/Demo_share.png" alt="Demo_share" />
  <figcaption>Demo_shareåº“å­˜åœ¨çš„ä¸¤å¼ è¡¨</figcaption>
</figure>
